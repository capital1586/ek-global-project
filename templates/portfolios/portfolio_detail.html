{% extends 'base.html' %}
{% load static %}
{% load tz %}
{% load humanize %}
{% load custom_filters %}

{% block title %}
<title>{{ portfolio.name }} Portfolio</title>
{% endblock title %}

{% block stylesheets %}

<!-- Preloads -->
<link rel="stylesheet" href="https://cdn.datatables.net/2.1.4/css/dataTables.dataTables.css" rel="preload">
<link href="{% static 'core/styles/form_card.css' %}" rel="stylesheet" rel="preload">
<link href="{% static 'core/styles/tabs.css' %}" rel="stylesheet" rel="preload">
<link href="{% static 'portfolios/styles/portfolio_detail.css' %}" rel="stylesheet" rel="preload">
<link rel="preload" as="script" href="https://cdn.datatables.net/2.1.4/js/dataTables.js">
<link rel="preload" as="script" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js" integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg==" crossorigin="anonymous" referrerpolicy="no-referrer">

<link rel="stylesheet" href="https://cdn.datatables.net/2.1.4/css/dataTables.dataTables.css" />
<link href="{% static 'core/styles/form_card.css' %}" rel="stylesheet">
<link href="{% static 'core/styles/tabs.css' %}" rel="stylesheet">
<link href="{% static 'portfolios/styles/portfolio_detail.css' %}" rel="stylesheet">

<style>
/* Custom modal backdrop styles */
.modal-backdrop {
    pointer-events: none !important;
    z-index: 1040 !important;
}

.modal {
    z-index: 1050 !important;
}

.modal-dialog {
    pointer-events: auto !important;
}

/* Modal theme styles */
.modal-content {
    background-color: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.modal-header {
    background-color: var(--bs-body-bg);
    border-bottom: 1px solid var(--bs-border-color);
}

.modal-body {
    background-color: var(--bs-body-bg);
    color: var(--bs-body-color);
}

.modal-footer {
    background-color: var(--bs-body-bg);
    border-top: 1px solid var(--bs-border-color);
}

/* Dark theme specific styles */
body.dark-theme .modal-content {
    background-color: #1a1a1a;
    border-color: #333;
}

body.dark-theme .modal-header {
    background-color: #1a1a1a;
    border-bottom-color: #333;
}

body.dark-theme .modal-body {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

body.dark-theme .modal-footer {
    background-color: #1a1a1a;
    border-top-color: #333;
}

/* Form elements in modal */
.modal .form-control {
    background-color: var(--bs-body-bg);
    border-color: var(--bs-border-color);
    color: var(--bs-body-color);
}

body.dark-theme .modal .form-control {
    background-color: #2a2a2a;
    border-color: #444;
    color: #e0e0e0;
}

.modal .form-control:focus {
    background-color: var(--bs-body-bg);
    border-color: var(--bs-primary);
    color: var(--bs-body-color);
}

body.dark-theme .modal .form-control:focus {
    background-color: #2a2a2a;
    border-color: var(--bs-primary);
    color: #e0e0e0;
}

/* Modal buttons */
.modal .btn-close {
    filter: var(--bs-btn-close-white);
}

body.dark-theme .modal .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}

/* Modal backdrop opacity */
.modal-backdrop.show {
    opacity: 0.7;
}

body.dark-theme .modal-backdrop.show {
    opacity: 0.9;
}
</style>
{% endblock stylesheets %}


{% block content %}
<!-- Transaction Add Modal -->
<div class="modal fade" id="transactionAddModal" style="display: none;" aria-hidden="true">
    <div class="modal-dialog" role="document" style="width: 90%; max-width: 600px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal">
                </button>
            </div>

            <div class="modal-body">
                <form action="{% url 'portfolios:investment_add' portfolio.id %}" method="post" id="transaction-add-form">
                    {% csrf_token %}
    
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="transaction_type">Transaction Type</label>
                            <select class="form-control form-select" name="transaction_type">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>

                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="stock">Stock</label>
                            <select class="form-control form-select" name="stock">
                                {% for stock in all_stocks %}
                                    <option value="{{ stock.ticker }}">
                                        {{ stock.ticker }}
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="rate">Price/Rate</label>
                            <input 
                                type="number" 
                                class="form-input form-control input-rounded" 
                                placeholder="Rate (PKR)" 
                                name="rate"
                                step="0.00001"
                                required
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="transaction_date">Transaction Date</label>
                            <input 
                                type="date"
                                class=" form-input form-control input-rounded" 
                                name="transaction_date"
                                value="{% now 'Y-m-d' %}"
                                max="{% now 'Y-m-d' %}"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="transaction_time">Transaction Time (Optional)</label>
                            <input 
                                type="time"
                                class=" form-input form-control input-rounded" 
                                name="transaction_time"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="quantity">Quantity</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="Quantity" 
                                name="quantity"
                                required
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="brokerage_fee">Brokerage Fee (percentage or exact value)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="Brokerage Fee"
                                name="brokerage_fee" 
                                min="0"
                                step="0.00001"
                                value="{{ portfolio.brokerage_percentage }}%"
                                required
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="settlement_date">Settlement Date (Optional)</label>
                            <input 
                                type="date" 
                                class="form-input form-control input-rounded" 
                                placeholder="Brokerage Fee"
                                name="settlement_date" 
                            >
                            <small class="field-message"></small>
                        </div>

                        <button 
                            type="button" 
                            class="btn btn-square btn-outline-light btn-sm" 
                            id="rate-fetch-btn"
                            data-url="{% url 'stocks:stock_latest_price' %}"
                        >
                            Fetch Current Rate
                        </button>
                    </div>

                    <h5 class="form-sub-head">Additional Costs</h5>
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="commission">Commission (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="Commission"
                                name="commission" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="cdc">CDC (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="CDC"
                                name="cdc" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="psx">PSX (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="PSX"
                                name="psx" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="secp">SECP (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="SECP"
                                name="secp" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="nccpl">NCCPL (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="NCCPL"
                                name="nccpl" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="cvt">CVT (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="CVT"
                                name="cvt" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="whts">WHTS (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="WHTS"
                                name="whts" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="whtc">WHTC (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="WHTC"
                                name="whtc" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="adv_tax">ADV Tax (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="ADV Tax"
                                name="adv_tax" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="sst">SST (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="SST"
                                name="sst" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="laga">LAGA (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="LAGA"
                                name="laga" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="nlaga">N-LAGA (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="N-LAGA"
                                name="nlaga" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="fed">FED (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="FED"
                                name="fed" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="misc">MISC (Optional)</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="MISC"
                                name="misc" 
                                min="0"
                                step="0.01"
                            >
                            <small class="field-message"></small>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn light btn-success btn-sm submit-btn">Add</button>
                        <button type="button" class="btn btn-danger light btn-sm" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>       
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Edit Modal -->
<div class="modal fade" id="portfolio{{ portfolio.id }}EditModal" style="display: none;" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Portfolio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal">
                </button>
            </div>
            
            <div class="modal-body">
                <form 
                    action="{% url 'portfolios:portfolio_update' portfolio.id %}" 
                    method="patch" 
                    class="portfolio-edit-form"
                    data-successURL="{% url 'portfolios:portfolio_detail' portfolio.id %}"
                >
                    {% csrf_token %}
    
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="name">Portfolio Name</label>
                            <input 
                                type="text" 
                                class="form-input form-control input-rounded" 
                                placeholder="Portfolio Name" 
                                name="name"
                                required
                                title="Edit the portfolio name."
                                value="{{ portfolio.name }}"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="brokerage_percentage">Brokerage Percentage (%)</label>
                            <input 
                                type="number" 
                                class="form-input form-control input-rounded" 
                                placeholder="Brokerage Percentage"
                                name="brokerage_percentage" 
                                min="0"
                                max="99.99"
                                step="0.01"
                                title="Update your default brokerage percentage."
                                value="{{ portfolio.brokerage_percentage }}"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="cash_addition">Cash Addition</label>
                            <input 
                                type="number" 
                                class="form-input form-control input-rounded" 
                                placeholder="Cash Addition (PKR)"
                                name="cash_addition" 
                                min="0"
                                step="0.01"
                                title="Add cash to your portfolio."
                                value="0.00"
                            >
                            <small class="field-message"></small>
                        </div>

                        <div class="form-field">
                            <label for="description">Description</label>
                            <textarea 
                                class="form-input form-control input-rounded" 
                                rows="7" 
                                placeholder="Description" 
                                name="description" 
                                title="Update the portfolio description."
                                value="{{ portfolio.description }}"
                            ></textarea>
                            <small class="field-message"></small>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn light btn-success btn-sm submit-btn">Done</button>
                        <button type="button" class="btn btn-danger light btn-sm" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>       
            </div>
        </div>
    </div>
</div>  

<!-- Dividends Update Modal -->
<div class="modal fade" id="dividendsUpdateModal" style="display: none;" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Dividend Received</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal">
                </button>
            </div>

            <div class="modal-body">
                <div class="col-md-6" style="width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
                    <p>Updates portfolio dividends record with additional amount received</p> 
                </div>
                
                <form
                    id="portfolio-dividends-update-form"  
                    action="{% url 'portfolios:portfolio_dividends_update' portfolio.id %}" 
                    method="post"
                >
                    {% csrf_token %}
    
                    <div class="form-fields">
                        <div class="form-field">
                            <label for="dividends">Dividend</label>
                            <input 
                                type="number" 
                                class="form-input form-control input-rounded" 
                                placeholder="Dividend Received (PKR)"
                                name="dividends" 
                                min="0"
                                step="0.01"
                                title="Record received dividend in portfolio."
                            >
                            <small class="field-message"></small>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn light btn-success btn-sm submit-btn">Add</button>
                        <button type="button" class="btn btn-danger light btn-sm" data-bs-dismiss="modal">Close</button>
                    </div>
                </form>       
            </div>
        </div>
    </div>
</div>

<!-- Stock Comparison Modal -->
<div class="modal fade" id="stockComparisonModal" style="display: none;" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Compare Stocks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal">
                </button>
            </div>
            
            <div class="modal-body">
                <div id="stock-comparison">
                    <div id="selected-stocks-section">
                        <h5>Selected stocks</h5>

                        <div id="selected-stocks">
                            <!-- Stocks selected for comparison go here -->
                        </div>
                    </div>

                    <div id="stock-choices-section">
                        <strong>Choose stocks to compare</strong>

                        <div id="stock-choices">
                            {% for stock in invested_stocks %}
                            <button 
                                type="button" 
                                class="btn btn-outline-primary btn-xs stock-choice"
                                data-value="{{ stock }}"
                            >
                                {{ stock }}
                                <i class="fas fa-plus fa-xs"></i>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> 

<!-- Alert Creation Modal -->
<div class="modal fade" id="createAlertModal" tabindex="-1" aria-labelledby="createAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createAlertModalLabel">
                    <i class="fas fa-bell me-2"></i> Create Alert for Portfolio Stock
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="portfolioAlertForm" method="post" action="{% url 'Alerts:portfolio_alert_create' %}">
                    {% csrf_token %}
                    <input type="hidden" id="portfolio_id" name="portfolio_id" value="{{ portfolio.id }}">
                    <input type="hidden" id="stock_id" name="stock_id" value="">
                    
                    <div class="mb-3">
                        <label for="alert_title" class="form-label">Alert Title</label>
                        <input type="text" class="form-control" id="alert_title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alert_description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="alert_description" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alert_symbol" class="form-label">Stock Symbol</label>
                        <input type="text" class="form-control" id="alert_symbol" name="symbol" required readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="alert_condition_type" class="form-label">Alert Condition</label>
                        <select class="form-select" id="alert_condition_type" name="condition_type" required>
                            <option value="" selected disabled>Select condition</option>
                            <option value="price_above">Price Above Threshold</option>
                            <option value="price_below">Price Below Threshold</option>
                            <option value="price_up_percent">Price Up by Percentage</option>
                            <option value="price_down_percent">Price Down by Percentage</option>
                            <option value="volume_spike">Volume Spike</option>
                            <option value="rsi_overbought">RSI Overbought (>70)</option>
                            <option value="rsi_oversold">RSI Oversold (<30)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3 threshold-field">
                        <label for="alert_threshold" class="form-label">Threshold Value</label>
                        <input type="number" step="0.01" class="form-control" id="alert_threshold" name="threshold_value">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notification Settings</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert_email" name="email_notification" checked>
                                <label class="form-check-label" for="alert_email">Email</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="alert_sound" name="sound_notification" checked>
                                <label class="form-check-label" for="alert_sound">Sound</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Save Alert
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-12">
        <div class="card text-white" id="primary-card">
            <div class="card-header flex-wrap">
                <h5 class="card-title text-white">{{ portfolio.name }} Portfolio</h5>

                <div class="dropdown custom-dropdown">
                    <div class="btn sharp btn-primary tp-btn" data-bs-toggle="dropdown" aria-expanded="true">
                        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18px" height="18px" viewBox="0 0 24 24" version="1.1"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><rect x="0" y="0" width="24" height="24"></rect><circle fill="#000000" cx="12" cy="5" r="2"></circle><circle fill="#000000" cx="12" cy="12" r="2"></circle><circle fill="#000000" cx="12" cy="19" r="2"></circle></g></svg>
                    </div>
                    <div class="dropdown-menu dropdown-menu-end" data-popper-placement="top-end" data-popper-reference-hidden="" style="position: absolute; inset: auto 0px 0px auto; margin: 0px; transform: translate(-1.01735px, -36.3924px);">
                        <a 
                            class="dropdown-item" 
                            href="javascript:voiud(0);" 
                            data-bs-toggle="modal"
                            data-bs-target="#portfolio{{ portfolio.id }}EditModal"
                        >
                            Edit
                        </a>
                        <a class="dropdown-item" href="{% url 'portfolios:portfolio_delete' portfolio.id %}">Delete</a>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="myTabContent4">
                <div class="tab-pane fade show active" id="Primarycard" role="tabpanel" aria-labelledby="home-tab">
                    <div class="card-body mb-0">
                        {% if portfolio.description %}
                        <p class="card-text">{{ portfolio.description }}</p>
                        {% else %}
                        <p class="card-text">No description</p>
                        {% endif %}
                    </div>
                </div>
            </div>	  
        </div>
    </div>

    <div id="portfolio-stats-wp">
        <section id="portfolio-stats">
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-warning text-warning">PKR</span>
                        <div class="media-body">
                            <p class="mb-1">Core Capital</p>
                            <h4 class="mb-0">{{ portfolio.capital|intcomma }}</h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="widget-stat card" id="net-balance-card" style="display: none;">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-success text-success">PKR</span>
                        <div class="media-body">
                            <p class="mb-1">Net Balance</p>
                            <h4 class="mb-0">{{ portfolio.cash_balance|intcomma }}</h4>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    {% with portfolio_value=portfolio.value %}
                    <div class="media ai-icon">
                        <span 
                            {% if portfolio_value %}
                                {% if portfolio_value < portfolio.capital %}
                                    class="me-3 bgl-danger text-danger"
                                {% else %}
                                    class="me-3 bgl-success text-success"
                                {% endif %}
    
                            {% else %}
                                class="me-3 bgl-info text-info"
                            {% endif %}
                        >
                            PKR
                        </span>
                        <div class="media-body">
                            <p class="mb-1">Net Value</p>
                            <h4 class="mb-0">{{ portfolio_value|intcomma }}</h4>
                        </div>
                    </div>
                    {% endwith %}
                </div>
            </div>
    
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span class="me-3 bgl-info text-info">PKR</span>
                        <div class="media-body">
                            <p class="mb-1">Core Investment</p>
                            <h4 class="mb-0">{{ portfolio.invested_capital|intcomma }}</h4>
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    {% with total_investments_value=portfolio.total_investments_value %}
                    <div class="media ai-icon">
                        <span 
                            {% if total_investments_value %}
                                {% if total_investments_value < portfolio.invested_capital %}
                                    class="me-3 bgl-danger text-danger"
                                {% else %}
                                    class="me-3 bgl-success text-success"
                                {% endif %}
    
                            {% else %}
                                class="me-3 bgl-info text-info"
                            {% endif %}
                        >
                            PKR
                        </span>
                        <div class="media-body">
                            <p class="mb-1">Investment Value</p>
                            <h4 class="mb-0">{{ total_investments_value|intcomma }}</h4>
                        </div>
                    </div>
                    {% endwith %}
                </div>
            </div>
    
            <div class="widget-stat card">
                <div class="card-body  p-4">
                    {% with total_return_on_investments=portfolio.total_return_on_investments %}
                    <div class="media ai-icon">
                        <span 
                        {% if total_return_on_investments %}
                            {% if total_return_on_investments.is_signed %}
                                class="me-3 bgl-danger text-danger"
                            {% else %}
                                class="me-3 bgl-success text-success"
                            {% endif %}
    
                        {% else %}
                            class="me-3 bgl-info text-info"
                        {% endif %}
                        >
                            PKR
                        </span>
                        <div class="media-body">
                            <p class="mb-1">Unrealized Gain or Loss</p>
                            <h4 class="mb-0">{{ total_return_on_investments|intcomma }}</h4>
    
                            {% if total_return_on_investments %}
                                {% with percentage_return_on_investments=portfolio.percentage_return_on_investments%}
                                <span 
                                    {% if percentage_return_on_investments.is_signed %}
                                        class="badge light badge-danger"
                                    {% else %}
                                        class="badge light badge-success"
                                    {% endif %}
                                >
                                    {{ percentage_return_on_investments }}%
                                </span>
                                {% endwith %}
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                </div>
            </div>

            <div class="widget-stat card">
                <div class="card-body  p-4">
                    {% with todays_return_on_investments=portfolio.todays_return_on_investments %}
                    <div class="media ai-icon">
                        <span 
                        {% if todays_return_on_investments %}
                            {% if todays_return_on_investments.is_signed %}
                                class="me-3 bgl-danger text-danger"
                            {% else %}
                                class="me-3 bgl-success text-success"
                            {% endif %}
    
                        {% else %}
                            class="me-3 bgl-info text-info"
                        {% endif %}
                        >
                            PKR
                        </span>
                        <div class="media-body">
                            <p class="mb-1">Net Return (1D)</p>
                            <h4 class="mb-0">{{ todays_return_on_investments|intcomma }}</h4>
                        </div>
                    </div>
                    {% endwith %}
                </div>
            </div>

            <div class="widget-stat card">
                <div class="card-body  p-4">
                    <div class="media ai-icon">
                        <span 
                        {% if portfolio.dividends %}
                            {% if portfolio.dividends.is_signed %}
                                class="me-3 bgl-info text-info"
                            {% else %}
                                class="me-3 bgl-success text-success"
                            {% endif %}
    
                        {% else %}
                            class="me-3 bgl-info text-info"
                        {% endif %}
                        >
                            PKR
                        </span>
                        <div class="media-body">
                            <p class="mb-1">Dividends</p>
                            <h4 class="mb-0">{{ portfolio.dividends|intcomma }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div style="display: flex; gap: 0 10px;">
            <button 
                type="button" 
                class="btn btn-primary btn-sm" 
                style="width: fit-content;" 
                id="net-balance-card-toggle"
                data-toggleText="Hide Net Balance"
            >
                Show Net Balance
            </button>

            <button 
                type="button" 
                class="btn btn-square btn-sm btn-light" 
                style="height: min-content;"
                data-bs-toggle="modal"
                data-bs-target="#dividendsUpdateModal"
            >
                Add Dividends
            </button>
        </div>
    </div>

    {% if portfolio.investments.exists %}
    <section id="charts-section">
        <div id="portfolio-performance" data-filterURL="{% url 'portfolios:portfolio_performance_data' portfolio.id %}">
            <div class="section-head">
                <div>
                    <h4>Portfolio Performance</h4>
                    <nav id="portfolio-performance-filters">
                        {% csrf_token %}
                        <ul class="pagination pagination-lg pagination-gutter pagination-warning">
                            <li class="page-item active">
                                <button class="page-link portfolio-performance-filter" data-value="5D">5D</button>
                            </li>
                            <li class="page-item">
                                <button class="page-link portfolio-performance-filter" data-value="1M">1M</button>
                            </li>
                            <li class="page-item">
                                <button class="page-link portfolio-performance-filter" data-value="3M">3M</button>
                            </li>
                            <li class="page-item">
                                <button class="page-link portfolio-performance-filter" data-value="6M">6M</button>
                            </li>
                            <li class="page-item">
                                <button class="page-link portfolio-performance-filter" data-value="1Y">1Y</button>
                            </li>
                            <li class="page-item">
                                <button class="page-link portfolio-performance-filter" data-value="5Y">5Y</button>
                            </li>
                        </ul>
                    </nav>
                </div>

                <button 
                    type="button" 
                    class="btn btn-square btn-sm btn-light" 
                    style="height: min-content;"
                    data-bs-toggle="modal"
                    data-bs-target="#stockComparisonModal"
                    id="stock-comparison-btn"
                >
                    Compare stocks
                    <span 
                        id="stock-comparison-counter" 
                        class="badge badge-circle badge-warning" 
                        style="display: none;"
                    >
                        __
                    </span>
                </button>
            </div>

            <div class="card chart-wrapper">
                <canvas id="portfolio-performance-chart" data-chartData="{{ line_chart_data }}">
                    <!-- Performance Line Chart -->
                </canvas>
            </div>
        </div>

        <div id="portfolio-allocation">
            <h4>Portfolio Allocation</h4>
            <div class="card chart-wrapper">
                <canvas id="portfolio-allocation-chart" data-chartData="{{ pie_chart_data }}">
                    <!-- Performance Pie Chart -->
                </canvas>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="tabs-section" id="portfolio-data-tabs-section" data-urlparam="tab">
        <nav class="tab-toggles-wp">
            <ul class="pagination pagination-lg pagination-gutter pagination-success tab-toggles-wp-inner">
                <li class="page-item active tab-toggle" data-tabtarget="transaction-history">
                    <button class="page-link" style="border-radius: 2px !important; padding: 7px 12px !important; font-size: 0.95rem;"">Transaction History</button>
                </li>
                <li class="page-item tab-toggle" data-tabtarget="stocks-summary">
                    <button class="page-link" style="border-radius: 2px !important; padding: 7px 12px !important; font-size: 0.95rem;"">Stocks Summary</button>
                </li>
            </ul>
        </nav> 
        
        <div class="tabs">
            {% timezone request.user.timezone %}
            <!-- Transactions Tab -->
            <div class="col-12 tab show-flex" id="transaction-history">
                <div class="card" style="border-radius: 2px;">
                    <div class="card-header">
                        <h4 class="card-title">Transactions</h4>

                        <button 
                            type="button" 
                            class="btn btn-light btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#transactionAddModal"
                        >
                            Add Transaction
                        </button>
                    </div>
                    <div class="card-body" style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="table-responsive">
                            <table id="portfolio-data-table" class="display" style="min-width: 845px">
                                <thead>
                                    <tr>
                                        <th style="width:80px;"><small>#</small></th>
                                        <th><small>Scrips</small></th>
                                        <th><small>Date</small></th>
                                        <th><small>Transaction</small></th>
                                        <th><small>No. of Shares</small></th>
                                        <th><small>Cost/Share (PKR)</small></th>
                                        <th><small>Brok. Fee/Share (PKR)</small></th>
                                        <th><small>Addl. Fees/Share (PKR)</small></th>
                                        <th><small>Total Cost (PKR)</small></th>
                                        <th><small>Market Value/Share (PKR)</small></th>
                                        <th><small>Market Value (PKR)</small></th>
                                        <th><small>Unrealized Gain/Loss</small></th>
                                        <th class="no-sort"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for investment in investments %}
                                    <tr>
                                        <td>
                                            <strong>
                                            {% with offset=page_obj.number|add:-1|multiply_int:page_obj.paginator.per_page %}
                                                {{ forloop.counter|add:offset }}
                                            {% endwith %}
                                            </strong>
                                        </td>
                                        <td>{{ investment.symbol }}</td>
                                        <td>{{ investment.transaction_date | default:"__" }}</td>
                                        <td>
                                            <span
                                                {% if investment.transaction_type == "buy" %}
                                                class="badge light badge-success"
                                                {% else %}
                                                class="badge light badge-danger"
                                                {% endif %}
                                            >
                                                {{ investment.transaction_type | title }}
                                            </span>
                                        </td>
                                        <td>{{ investment.quantity }}</td>
                                        <td>{{ investment.rate }}</td>
                                        <td>{{ investment.brokerage_fee }}</td>
                                        <td>{{ investment.additional_fees }}</td>
                                        <td>{{ investment.cost }}</td>
                                        <td>{{ investment.current_rate | default:"__" }}</td>
                                        <td>{{ investment.value | default:"__" }}</td>
                                        <td style="text-align: right;">
                                            {% with return_value=investment.return_value percentage_return=investment.percentage_return %}
                                                {{ return_value | default:"__" }}
                                                
                                                {% if return_value %}
                                                    {% if percentage_return.is_signed %}
                                                    <strong class="badge light badge-danger">
                                                        {{ percentage_return | default:"__" }}%
                                                    </strong>
                                                    {% else %}
                                                    <strong class="badge light badge-success">
                                                        {{ percentage_return | default:"__" }}%
                                                    </strong>
                                                    {% endif %}
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <a 
                                                href="{% url 'portfolios:investment_delete' portfolio.id investment.id %}" 
                                                class="btn btn-danger shadow btn-xs sharp"
                                            >
                                                <i class="fa fa-trash"></i>
                                            </a>
                                            <button 
                                                class="btn btn-primary shadow btn-xs sharp create-alert-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#createAlertModal"
                                                data-investment-id="{{ investment.id }}"
                                                data-symbol="{{ investment.symbol }}"
                                            >
                                                <i class="fa fa-bell"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginator -->
                        {% if page_obj.paginator.num_pages > 1 %}
                        <nav style="align-self: flex-end;">
                            <ul class="pagination pagination-gutter">
                                {% if page_obj.has_previous %}
                                <li class="page-item page-indicator">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                        <i class="la la-angle-left"></i>
                                    </a>
                                </li>
                                {% endif %}

                                {# Display a range of page numbers around the current page #}
                                {% for num in page_obj.paginator.page_range %}
                                    {% if num > page_obj.number|add:'-2' and num < page_obj.number|add:'2' %}
                                        {% if num == page_obj.number %}
                                            <li class="page-item active">
                                                <a class="page-link" href="javascript:void(0)">{{ num }}</a>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                <li class="page-item page-indicator">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                        <i class="la la-angle-right"></i>
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endtimezone %}

            <!-- Stocks Summary Tab -->
            <div class="col-12 tab" id="stocks-summary">
                <div class="card" style="border-radius: 2px;">
                    <div class="card-header">
                        <h4 class="card-title">Summary ({{ stocks_summary_dt_filter | upper }})</h4>

                        <nav id="stocks-summary-filters-wp" data-activefilter="{{ stocks_summary_dt_filter | upper }}">
                            {% csrf_token %}
                            <ul class="pagination pagination-sm pagination-gutter pagination-warning">
                                <li class="page-item active stocks-summary-filter">
                                    <button class="page-link" data-value="5D">5D</button>
                                </li>
                                <li class="page-item stocks-summary-filter">
                                    <button class="page-link" data-value="1M">1M</button>
                                </li>
                                <li class="page-item stocks-summary-filter">
                                    <button class="page-link" data-value="3M">3M</button>
                                </li>
                                <li class="page-item stocks-summary-filter">
                                    <button class="page-link" data-value="6M">6M</button>
                                </li>
                                <li class="page-item stocks-summary-filter">
                                    <button class="page-link" data-value="1Y">1Y</button>
                                </li>
                                <li class="page-item stocks-summary-filter">
                                    <button class="page-link" data-value="5Y">5Y</button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="stocks-summary-data-table" class="display" style="min-width: 845px">
                                <thead>
                                    <tr>
                                        <th class="no-sort"><small>Scrips</small></th>
                                        <th><small>% of Shares</small></th>
                                        <th><small>No. of Shares</small></th>
                                        <th><small>Cost/Share (PKR)</small></th>
                                        <th><small>Total Cost (PKR)</small></th>
                                        <th><small>Market Value/Share (PKR)</small></th>
                                        <th><small>Market Value (PKR)</small></th>
                                        <th><small>Unrealized Gain/Loss</small></th>
                                        <th class="no-sort"><small>Actions</small></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stock_summary in stocks_summary %}
                                    <tr
                                        {% if forloop.last %}
                                        style="text-transform: uppercase !important; background: #888 !important;"
                                        {% endif %}
                                    >
                                        <td>{{ stock_summary.symbol }}</td>
                                        <td>{{ stock_summary.percentage_allocation | default:"__" }}%</td>
                                        <td>{{ stock_summary.net_quantity }}</td>
                                        <td>{{ stock_summary.average_rate | default:"__" }}</td>
                                        <td>{{ stock_summary.net_average_cost }}</td>
                                        <td>{{ stock_summary.market_rate | default:"__" }}</td>
                                        <td>{{ stock_summary.market_value | default:"__" }}</td>
                                        <td style="text-align: right;">
                                            {{ stock_summary.net_return_on_investments | default:"__" }}
                                            
                                            {% if stock_summary.net_return_on_investments %}
                                                {% if stock_summary.percentage_return_on_investments.is_signed %}
                                                <strong class="badge light badge-danger">
                                                    {{ stock_summary.percentage_return_on_investments | default:"__" }}%
                                                </strong>
                                                {% else %}
                                                <strong class="badge light badge-success">
                                                    {{ stock_summary.percentage_return_on_investments | default:"__" }}%
                                                </strong>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if not forloop.last %}
                                            <button 
                                                class="btn btn-primary shadow btn-xs sharp create-alert-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#createAlertModal"
                                                data-investment-id=""
                                                data-symbol="{{ stock_summary.symbol }}"
                                            >
                                                <i class="fa fa-bell"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}


{% block scripts %}
<script src="https://cdn.datatables.net/2.1.4/js/dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js" integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="{% static 'core//scripts//formCard.js' %}"></script>
<script src="{% static 'core//scripts//tabs.js' %}"></script>
<script src="{% static 'portfolios//scripts//transactionAdd.js' %}"></script>
<script src="{% static 'portfolios//scripts//portfolioEdit.js' %}"></script>
<script src="{% static 'portfolios//scripts//portfolioDividendsUpdate.js' %}"></script>
<script src="{% static 'portfolios//scripts//portfolioDetail.js' %}"></script>
<script src="{% static 'portfolios//scripts//portfolioDataTables.js' %}"></script>
<script src="{% static 'portfolios//scripts//portfolioAllocationChart.js' %}"></script>
<script src="{% static 'portfolios//scripts//portfolioPerformanceChart.js' %}"></script>
{% endblock scripts %}

{% block javascript %}
<!-- Alert Creation Functionality -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle alert button clicks
        const alertButtons = document.querySelectorAll('.create-alert-btn');
        
        alertButtons.forEach(button => {
            button.addEventListener('click', function() {
                const investmentId = this.getAttribute('data-investment-id');
                const symbol = this.getAttribute('data-symbol');
                
                // Set values in the form
                document.getElementById('stock_id').value = investmentId;
                document.getElementById('alert_symbol').value = symbol;
                document.getElementById('alert_title').value = `Alert for ${symbol} in ${portfolioName}`;
                
                // Focus the condition dropdown
                document.getElementById('alert_condition_type').focus();
            });
        });

        // Get portfolio name for alert title
        const portfolioName = "{{ portfolio.name }}";
        
        // Handle condition type changes
        const conditionTypeSelect = document.getElementById('alert_condition_type');
        const thresholdField = document.querySelector('.threshold-field');
        
        if (conditionTypeSelect) {
            conditionTypeSelect.addEventListener('change', function() {
                if (this.value) {
                    thresholdField.style.display = 'block';
                    document.getElementById('alert_threshold').focus();
                } else {
                    thresholdField.style.display = 'none';
                }
            });
        }

        // Handle form submission
        const alertForm = document.getElementById('portfolioAlertForm');
        if (alertForm) {
            alertForm.addEventListener('submit', function(e) {
                // Let the form submit naturally
                // The backend will handle the alert creation
            });
        }
    });
</script>
{% endblock %}
 