{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block stylesheets %}

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
    /* Enhanced professional styles */
        :root {
            /* Light Theme (Default) */
            --primary-color: #1e3a8a; /* Deep Blue */
            --primary-light: #3b82f6; /* Brighter Blue */
            --primary-hover: #2563eb; /* Hover Blue */
            --secondary-color: #10b981; /* Teal */
            --light-gray: #f3f4f6; /* Very Light Gray */
            --medium-gray: #e5e7eb; /* Light Gray */
            --dark-gray: #6b7280; /* Medium Gray */
            --text-color: #334155; /* Dark Slate */
            --text-light: #4b5563; /* Lighter Slate */
            --text-inverted: #ffffff; /* White */
            --background-color: #f8fafc; /* Off White */
            --content-bg: #ffffff; /* White */
            --positive: #16a34a; /* Green */
            --negative: #dc2626; /* Red */
            --border-color: #e5e7eb; /* Light Border */
            --tab-hover: #f9fafb;
            --header-bg: #f8fafc;
            --table-header-bg: #f1f5f9; /* Very Light Blue-Gray */
            --table-stripe-odd: #f9fafb; /* Off White */
            --table-stripe-even: #ffffff; /* White */
            --table-hover: #eef2ff; /* Very Light Indigo */
            --filter-header-bg: #e5e7eb;
            --filter-row-bg: #f9fafb;
            --table-header-color: #1e3a8a;
            --table-header-hover: #3b82f6;
            --positive-bg: rgba(22, 163, 74, 0.1);
            --negative-bg: rgba(220, 38, 38, 0.1);
            --primary: var(--primary-color);
            --primary-dark: #1a2e6b; /* Darker Blue */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --input-bg: #ffffff;
            --input-border: var(--border-color);
            --input-focus-border: var(--primary-light);
            --input-focus-shadow: rgba(59, 130, 246, 0.15);
            --select-arrow-color: '#343a40'; /* Color needs to be hex for SVG URL */
            --link-color: var(--primary-color);
            --link-hover-color: var(--primary-hover);
            --tooltip-bg: #334155;
            --tooltip-text: #ffffff;
            --spinner-bg: rgba(255, 255, 255, 0.8);
            --spinner-color: var(--primary-color);
            --spinner-track-color: rgba(30, 58, 138, 0.1);

            --transition: all 0.2s ease;
            --radius-sm: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            
            /* RGB versions for opacity manipulation */
            --primary-color-rgb: 30, 58, 138;
            --primary-light-rgb: 59, 130, 246;
            --content-bg-rgb: 255, 255, 255;
            --positive-rgb: 22, 163, 74;
            --negative-rgb: 220, 38, 38;
        }

        /* Dark Theme Variables */
        body.dark-theme {
            --primary-color: #60a5fa; /* Lighter Blue */
            --primary-light: #93c5fd;
            --primary-hover: #3b82f6;
            --secondary-color: #14b8a6; /* Keep Teal or slightly adjust */
            --light-gray: #4b5563; /* Dark Gray */
            --medium-gray: #374151; /* Darker Gray */
            --dark-gray: #9ca3af; /* Light Gray (for text) */
            --text-color: #e5e7eb; /* Very Light Gray */
            --text-light: #d1d5db; /* Lighter Gray */
            --text-inverted: #1f2937; /* Dark Gray */
            --background-color: #111827; /* Very Dark Blue/Gray */
            --content-bg: #1f2937; /* Dark Blue/Gray */
            --positive: #22c55e; /* Brighter Green */
            --negative: #ef4444; /* Brighter Red */
            --border-color: #374151; /* Dark Gray Border */
            --tab-hover: #374151;
            --header-bg: #1f2937;
            --table-header-bg: #374151; /* Dark Gray */
            --table-stripe-odd: #1f2937; /* Dark Blue/Gray */
            --table-stripe-even: #212936; /* Slightly Lighter Dark */
            --table-hover: #374151; /* Dark Gray */
            --filter-header-bg: #4b5563;
            --filter-row-bg: #374151;
            --table-header-color: #e5e7eb; /* Light Text */
            --table-header-hover: #ffffff;
            --positive-bg: rgba(34, 197, 94, 0.15);
            --negative-bg: rgba(239, 68, 68, 0.15);
            --primary: var(--primary-color);
            --primary-dark: #3b82f6; /* Match hover for dark mode */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.15);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.2);
            --input-bg: #374151;
            --input-border: #4b5563;
            --input-focus-border: var(--primary-light);
            --input-focus-shadow: rgba(147, 197, 253, 0.2);
            --select-arrow-color: '#9ca3af'; /* Light Gray for arrow */
            --link-color: var(--primary-light);
            --link-hover-color: #dbeafe; /* Very Light Blue */
            --tooltip-bg: #e5e7eb;
            --tooltip-text: #1f2937;
            --spinner-bg: rgba(17, 24, 39, 0.8);
            --spinner-color: var(--primary-light);
            --spinner-track-color: rgba(96, 165, 250, 0.2);
            
            /* RGB versions for opacity manipulation */
            --primary-color-rgb: 96, 165, 250;
            --primary-light-rgb: 147, 197, 253;
            --content-bg-rgb: 31, 41, 55;
            --positive-rgb: 34, 197, 94;
            --negative-rgb: 239, 68, 68;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth theme transition */
        }

        /* Screener layout */
        .screener-container {
            margin: 1.5rem auto;
            max-width: 100%;
            font-size: 0.9rem;
            background-color: var(--content-bg);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-color); /* Subtle border */
        }

        /* Header styles */
        .screener-header {
            padding: 1.25rem;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .header-controls span {
            font-weight: 500;
            color: var(--dark-gray);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .search-group {
            flex-grow: 1;
            max-width: 300px;
        }

        .control-select,
        .control-input {
            height: 2.25rem;
            border: 1px solid var(--input-border);
            border-radius: var(--radius-md);
            padding: 0 0.75rem;
            font-size: 0.875rem;
            background-color: var(--input-bg);
            color: var(--text-color); /* Ensure text is readable */
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }

        .control-select {
            min-width: 120px;
            -webkit-appearance: none;
            appearance: none; /* Standard property */
            /* Dynamic SVG background using CSS variable */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='{--select-arrow-color}' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e".replace('{--select-arrow-color}', getComputedStyle(document.documentElement).getPropertyValue('--select-arrow-color').trim().replace('#', '%23')));
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 16px 12px;
            padding-right: 2rem;
        }

        /* Need JS to update SVG on theme change, or use a more robust method */
        /* Alternative: Use a static SVG suitable for both or use :after pseudo-element */
        /* For simplicity, we'll assume JS updates it or use a neutral color initially */
        .control-select {
             /* Example using a neutral color */
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        }
        body.dark-theme .control-select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        }


        .control-input {
            flex-grow: 1;
        }
        .control-input::placeholder { /* Style placeholder */
            color: var(--dark-gray);
            opacity: 0.7;
        }


        .search-input-group {
            display: flex;
            flex-grow: 1;
        }
        .search-input-group .control-input {
             border-radius: var(--radius-md) 0 0 var(--radius-md);
        }

        .search-input-group .btn-filter {
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            margin-left: -1px; /* Overlap borders */
        }

        .filter-status {
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: var(--dark-gray);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .me-1 {
            margin-right: 0.25rem;
        }

        .filter-icon {
            margin-left: 0.25rem;
        }

        /* Filter tabs */
        .filter-tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--table-header-bg); /* Match table header */
            padding: 0 1rem;
        }

        .filter-tab {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            background-color: transparent;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            margin-right: 0.25rem;
            margin-bottom: -1px; /* Overlap bottom border */
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-light);
        }

        .filter-tab:hover {
            background-color: var(--tab-hover);
            color: var(--link-hover-color);
        }

        .filter-tab.active {
            background-color: var(--content-bg); /* Match main content background */
            border-color: var(--border-color);
            border-bottom: 2px solid var(--content-bg); /* Hide bottom border segment */
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Filter rows */
        .filter-section {
            background-color: var(--content-bg);
            padding: 0; /* Padding handled by grid cells */
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
        }

        .filter-count-header {
            background-color: var(--filter-header-bg);
            padding: 0.5rem 1rem;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Responsive grid */
            gap: 0; /* Use borders for separation */
            width: 100%;
        }

        .filter-cell {
            display: flex;
            flex-direction: column;
            padding: 0.6rem;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--filter-row-bg);
            /* Remove border on last column of each row - complex with auto-fill */
            /* Simpler: rely on container border */
        }
        /* Remove right border on the very last cell if needed */
         .filter-grid .filter-cell:last-child {
             /* border-right: none; Might not be accurate with auto-fill */
         }
         /* Remove bottom border for cells in the last row - complex */


        .filter-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--dark-gray);
            margin-bottom: 0.25rem;
        }

        .filter-value select {
            width: 100%;
            height: 2rem;
            border: 1px solid var(--input-border);
            border-radius: var(--radius-sm);
            padding: 0 0.5rem;
            font-size: 0.75rem;
            background-color: var(--input-bg);
            color: var(--text-color); /* Text color for select */
             -webkit-appearance: none;
             appearance: none;
             /* Re-apply dynamic background */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 12px 10px;
            padding-right: 1.5rem;
        }
        body.dark-theme .filter-value select {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        }


        .filter-value select:focus {
            border-color: var(--input-focus-border);
            outline: none;
            box-shadow: 0 0 0 2px var(--input-focus-shadow);
        }

        /* Buttons */
        .btn-filter {
            background-color: var(--primary-color);
            color: var(--text-inverted);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            min-height: 2.25rem;
            font-size: 0.875rem;
        }

        .btn-filter:hover {
            background-color: var(--primary-hover);
            box-shadow: var(--shadow-md);
        }
        body.dark-theme .btn-filter {
            color: var(--text-inverted); /* Ensure contrast if primary color is light */
        }


        .btn-reset {
            background-color: var(--light-gray);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1.25rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            margin-top: 0.75rem; /* Adjust as needed */
            font-size: 0.875rem;
        }

        .btn-reset:hover {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }

        /* Stock table */
        .stock-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem; /* Slightly smaller */
            /* Removed shadow, relying on container */
            margin-bottom: 1.5rem;
            border-top: 1px solid var(--border-color); /* Add top border */
        }

        .stock-table thead th {
            background-color: var(--table-header-bg);
            color: var(--table-header-color);
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
            border-bottom: 2px solid var(--border-color); /* Slightly thicker bottom border */
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap; /* Prevent header wrapping */
        }

        .stock-table thead th.sorting-enabled {
            cursor: pointer;
        }

        .stock-table thead th.sorting-enabled:hover {
            background-color: var(--medium-gray); /* Subtle hover */
            color: var(--table-header-hover);
        }
        body.dark-theme .stock-table thead th.sorting-enabled:hover {
             background-color: var(--light-gray); /* Adjust dark hover */
        }

        .stock-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            position: relative;
        }
        .stock-table tbody tr:nth-child(odd) {
            background-color: var(--table-stripe-odd);
        }
        .stock-table tbody tr:nth-child(even) {
            background-color: var(--table-stripe-even);
        }

        .stock-table tbody tr:hover {
            background-color: var(--table-hover);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            /* transform: translateY(-1px); Remove slight jump */
            z-index: 1;
        }
        body.dark-theme .stock-table tbody tr:hover {
             box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
        }

        .stock-table td {
            padding: 0.75rem;
            vertical-align: middle;
        }

        .stock-table .text-right {
            text-align: right;
        }

        .stock-table .stock-link {
            position: relative; /* Needed for preview positioning */
            color: var(--link-color);
            font-weight: 600;
            text-decoration: none;
        }
        .stock-table .stock-link:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        /* Remove the old tooltip style */
        .stock-table .stock-link::after {
            /* content: attr(data-symbol); */
            /* display: none; Replaced by preview */
        }


        .stock-table .positive {
            color: var(--positive);
            font-weight: 500;
        }

        .stock-table .negative {
            color: var(--negative);
            font-weight: 500;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 0.3rem; /* Reduced gap */
            margin: 1.5rem 0;
            padding: 0 1rem; /* Add padding for small screens */
        }

        .pagination .page-item {
            list-style: none;
        }

        .pagination .page-link {
            display: inline-block;
            padding: 0.4rem 0.75rem; /* Slightly smaller padding */
            text-decoration: none;
            color: var(--link-color);
            background-color: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm); /* Smaller radius */
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .pagination .page-link:hover {
            background-color: var(--light-gray);
            color: var(--link-hover-color);
            border-color: var(--medium-gray);
        }

        .pagination .active .page-link {
            background-color: var(--primary-color);
            color: var(--text-inverted);
            border-color: var(--primary-color);
            font-weight: 600;
        }
        body.dark-theme .pagination .active .page-link {
            color: var(--text-inverted); /* Ensure contrast */
        }

        .pagination .disabled .page-link {
            color: var(--dark-gray);
            pointer-events: none;
            background-color: var(--content-bg);
            border-color: var(--border-color);
            opacity: 0.6;
        }

        /* Stock results header */
        .stock-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping */
            gap: 0.75rem; /* Add gap for wrapped items */
            padding: 0.75rem 1.25rem; /* Reduced padding */
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.875rem;
            /* Removed border-radius as it's part of the main container */
        }

        .stock-results-header a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 500;
        }

        .stock-results-header a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.2rem 0.6rem; /* Adjusted padding */
            font-size: 0.7rem; /* Smaller font */
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 9999px; /* Pill shape */
            background-color: var(--primary-light);
            color: var(--text-inverted);
            margin: 0 0.25rem; /* Add spacing */
        }
        body.dark-theme .badge {
            background-color: var(--primary);
            color: var(--text-inverted); /* Ensure contrast */
        }


        /* Dashboard tabs (if needed elsewhere) */
        .dashboard-tabs {
            margin-top: 1.5rem;
        }

        /* Utilities */
        .text-center { text-align: center; }
        .mt-3 { margin-top: 1rem; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .filter-grid {
                /* Already responsive with auto-fill */
            }
            .header-controls {
                flex-direction: column;
                align-items: stretch; /* Stretch items full width */
            }
             .control-group {
                 width: 100%; /* Make control groups take full width */
                 justify-content: space-between; /* Space out labels and selects */
             }
             .search-group {
                 max-width: none; /* Remove max-width */
             }
        }

        .control-select:focus, .control-input:focus {
            border-color: var(--input-focus-border);
            outline: none;
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
        }

        .filter-status .badge {
            margin-left: 0.5rem;
        }

        /* Statistics Bar */
        .statistics-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping */
            gap: 1rem; /* Gap between items */
            background-color: var(--header-bg); /* Use header background */
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.25rem;
            margin: 0; /* Integrate into flow */
            font-size: 0.85rem; /* Slightly smaller */
        }

        .filter-summary, .market-stats {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Allow inner wrapping */
            gap: 0.75rem;
        }

        .market-stats {
            gap: 1.5rem; /* Larger gap between market stats */
        }

        .stats-label {
            font-weight: 600;
            color: var(--text-light);
        }

        .stats-value {
            color: var(--text-color);
            font-weight: 500;
        }

        .filter-count {
            /* Use badge style but maybe slightly larger */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-color);
            color: var(--text-inverted);
            font-weight: 600;
            min-width: 22px;
            height: 22px;
            border-radius: 11px;
            padding: 0 7px;
            font-size: 0.75rem;
        }
        body.dark-theme .filter-count {
             color: var(--text-inverted);
        }

        .stats-value.positive { color: var(--positive); }
        .stats-value.negative { color: var(--negative); }

        @media (max-width: 768px) {
            .statistics-bar {
                /* Already wraps */
                 justify-content: flex-start; /* Align left when wrapped */
            }
        }

        /* Market Chart Styles */
        .market-chart-section {
            margin: 1.5rem 0 0 0; /* Adjust margin */
            background-color: var(--content-bg);
            border-radius: 0; /* Remove radius if inside main container */
            border: none; /* Remove border if inside main container */
            border-top: 1px solid var(--border-color); /* Add separator */
            overflow: hidden;
        }

        .chart-toggle {
            display: flex;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 1rem; /* Adjust padding */
            overflow-x: auto; /* Allow horizontal scroll on mobile */
            white-space: nowrap;
        }

        .chart-btn {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            margin-right: 0.25rem; /* Add space between buttons */
        }

        .chart-btn:hover {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }

        .chart-btn.active {
            background-color: var(--primary-color);
            color: var(--text-inverted);
        }
        body.dark-theme .chart-btn.active {
            color: var(--text-inverted);
        }

        /* Chart containers */
        .chart-container {
            display: none;
            height: 450px; /* Fixed height for charts */
            width: 100%;
            border: 1px solid var(--border-color);
            background-color: var(--content-bg);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 20px;
            overflow: hidden; /* Ensure no overflow */
        }

        .chart-container.active {
            display: block;
        }

        /* Error state for charts */
        .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--dark-gray);
            font-style: italic;
            text-align: center;
            background-color: rgba(var(--content-bg-rgb), 0.7);
            padding: 20px;
        }

        /* Placeholder Chart SVG */
        #market-chart {
            width: 100%;
            height: 100%;
             /* Use CSS gradients or a theme-aware SVG if possible */
             /* Simple placeholder background */
            background: linear-gradient(to top, var(--primary-bg-light) 0%, var(--content-bg) 70%);
            border: 1px dashed var(--border-color); /* Indicate placeholder */
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dark-gray);
            font-style: italic;
        }
        #market-chart::before {
             content: 'Market Chart Placeholder';
        }
        /* Remove the complex SVG background */


        @media (max-width: 640px) {
            .chart-container {
                height: 200px;
            }
        }

        /* Company Profile Preview */
        .stock-preview {
            position: absolute;
            left: 0;
            top: 100%;
            width: 280px; /* Slightly wider */
            background-color: var(--content-bg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg); /* Use defined shadow */
            padding: 1rem;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px) scale(0.95); /* Add scale */
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 0.85rem;
            margin-top: 8px; /* Increased margin */
            border: 1px solid var(--border-color);
            color: var(--text-color); /* Ensure text color */
        }

        .stock-link:hover .stock-preview {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .preview-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem; /* Increased margin */
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-logo {
            width: 32px; /* Slightly larger */
            height: 32px;
            background-color: var(--light-gray); /* Use variable */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--primary-color); /* Use variable */
            flex-shrink: 0; /* Prevent shrinking */
        }

        .preview-name {
            font-weight: 600;
            font-size: 1rem; /* Larger name */
            color: var(--text-color); /* Use variable */
            line-height: 1.2;
        }

        .preview-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem; /* Increased gap */
            margin-bottom: 0.75rem;
        }

        .preview-stat {
            display: flex;
            flex-direction: column;
        }

        .preview-label {
            font-size: 0.7rem; /* Smaller label */
            color: var(--dark-gray); /* Use variable */
            text-transform: uppercase; /* Uppercase label */
            margin-bottom: 0.1rem;
        }

        .preview-value {
            font-weight: 500;
            font-size: 0.9rem; /* Slightly larger value */
            color: var(--text-color); /* Use variable */
        }
        .preview-value.positive { color: var(--positive); }
        .preview-value.negative { color: var(--negative); }


        .preview-desc {
            font-size: 0.8rem; /* Adjusted size */
            color: var(--text-light); /* Use variable */
            line-height: 1.4;
            margin-top: 0.75rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Loading spinner */
        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--spinner-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .spinner-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--spinner-track-color);
            border-radius: 50%;
            border-top-color: var(--spinner-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Theme Toggle Button Style */
        .btn-theme-toggle {
            background: none;
            border: 1px solid var(--input-border);
            color: var(--text-light);
            padding: 0.4rem 0.6rem; /* Adjust padding */
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem; /* Adjust icon size */
            line-height: 1; /* Ensure icon fits */
            margin-left: auto; /* Push to the right if possible */
        }

        .btn-theme-toggle:hover {
            background-color: var(--light-gray);
            border-color: var(--medium-gray);
            color: var(--text-color);
        }
        .btn-theme-toggle i {
            display: block; /* Prevent extra space */
        }


        /* Mobile Improvements */
        .table-section { /* Wrapper for table on mobile */
            overflow-x: auto;
            width: 100%;
            margin-bottom: 1rem; /* Add space below table */
        }
        @media (max-width: 768px) {
            .screener-header {
                 padding: 1rem;
            }
            .stock-table {
                font-size: 0.8rem;
            }
            .stock-table th,
            .stock-table td {
                padding: 0.6rem 0.4rem; /* Reduced padding */
                 white-space: nowrap; /* Prevent wrapping in cells */
            }
            .filter-section {
                /* Padding handled by cells */
            }
            .filter-cell {
                 border-right: none; /* Remove internal borders */
                 border-bottom: 1px solid var(--border-color);
            }
             .filter-cell:last-child {
                 border-bottom: none;
             }
             .filter-grid {
                  grid-template-columns: 1fr; /* Stack filters */
             }
            .stock-preview { /* Adjust preview on mobile */
                width: 90vw;
                max-width: 300px;
                left: 50%;
                transform: translateX(-50%) translateY(10px) scale(0.95);
            }
            .stock-link:hover .stock-preview {
                 transform: translateX(-50%) translateY(0) scale(1);
            }

        }

        @media (max-width: 480px) {
            /* Hide less critical columns on very small screens */
            .stock-table tr th:nth-child(4), /* Sector */
            .stock-table tr th:nth-child(5), /* Industry */
            .stock-table tr th:nth-child(6), /* Country */
            .stock-table tr th:nth-child(8), /* P/E */
            .stock-table tr td:nth-child(4),
            .stock-table tr td:nth-child(5),
            .stock-table tr td:nth-child(6),
            .stock-table tr td:nth-child(8) {
                 display: none;
            }
            .filter-tabs {
                 padding: 0 0.5rem;
            }
            .filter-tab {
                font-size: 0.8rem;
                padding: 0.75rem 0.5rem;
            }
            .stock-results-header {
                 padding: 0.75rem;
                 font-size: 0.8rem;
            }
            .statistics-bar {
                 padding: 0.75rem;
                 font-size: 0.8rem;
            }
        }

        .filter-cell.locked .filter-label {
            position: relative;
            opacity: 0.7;
        }

        .filter-cell.locked .filter-label::after {
            content: "\f023";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-left: 6px;
            color: var(--dark-gray);
            display: inline-block;  /* Ensure the icon is displayed */
            font-size: 0.8rem;      /* Adjust the size */
        }

        body.dark-theme .filter-cell.locked .filter-label::after {
            color: var(--light-gray);
        }

        .filter-cell.locked .filter-value select {
            opacity: 0.7;
            cursor: not-allowed;
            background-color: var(--medium-gray);
            pointer-events: none;
        }

        body.dark-theme .filter-cell.locked .filter-value select {
            background-color: var(--dark-gray);
            opacity: 0.5;
        }

        /* Enhance the lock icon styling */
        .filter-cell.locked .filter-label i.fa-lock {
            margin-left: 5px;
            color: var(--dark-gray);
            font-size: 0.8rem;
        }

        body.dark-theme .filter-cell.locked .filter-label i.fa-lock {
            color: var(--light-gray);
        }

        /* Make the locked fields visually distinct */
        .filter-cell.locked {
            background-color: rgba(0, 0, 0, 0.03);
        }

        body.dark-theme .filter-cell.locked {
            background-color: rgba(0, 0, 0, 0.15);
        }

        /* Locked tab styling */
        .filter-tab.locked {
            position: relative;
            background-color: rgba(0, 0, 0, 0.03);
            color: var(--dark-gray);
            cursor: pointer;
        }

        .filter-tab.locked i.fa-lock {
            font-size: 0.8rem;
            margin-left: 5px;
            color: var(--primary-color);
        }

        body.dark-theme .filter-tab.locked {
            background-color: rgba(0, 0, 0, 0.15);
        }

        /* Premium feature alert */
        .premium-feature-alert {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--content-bg);
            border: 1px solid var(--primary-color);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 350px;
            text-align: center;
            display: none;
        }

        .premium-feature-alert h3 {
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.2rem;
        }

        .premium-feature-alert p {
            margin-bottom: 1.2rem;
            font-size: 0.9rem;
        }

        .premium-feature-alert .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .premium-feature-alert .btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 500;
        }

        .premium-feature-alert .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .premium-feature-alert .btn-secondary:hover {
            background-color: var(--medium-gray);
        }

        /* Improve action button icons styling */
        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: var(--light-gray);
            color: var(--primary-color);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 2px;
        }
        
        .btn-action:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
        }
        
        body.dark-theme .btn-action {
            background-color: var(--medium-gray);
            color: var(--primary-light);
        }
        
        body.dark-theme .btn-action:hover {
            background-color: var(--primary-light);
            color: var(--text-inverted);
        }

        /* View Toggle Button Group */
        .view-toggle {
            display: flex;
            align-items: center;
            background-color: var(--light-gray);
            border-radius: var(--radius-md);
            padding: 0.25rem;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }

        .view-toggle button {
            background: none;
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            color: var(--text-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .view-toggle button.active {
            background-color: var(--content-bg);
            color: var(--primary-color);
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        /* Chart containers */
        .chart-view {
            display: none;
            padding: 1rem;
            background-color: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-top: 1rem;
        }

        .chart-container {
            display: none;
            height: 450px; /* Fixed height for charts */
        }

        .chart-container.active {
            display: block;
        }

        .chart-type-toggle {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chart-type-toggle button {
            background-color: var(--light-gray);
            color: var(--text-light);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .chart-type-toggle button.active {
            background-color: var(--primary-color);
            color: var(--text-inverted);
            border-color: var(--primary-color);
        }

        body.dark-theme .chart-type-toggle button.active {
            background-color: var(--primary-color);
            border-color: var(--primary-hover);
        }

        .chart-info {
            display: none;
            padding: 0.75rem 1rem;
            background-color: rgba(var(--primary-color-rgb, 30, 58, 138), 0.05);
            border-left: 3px solid var(--primary-color);
            border-radius: var(--radius-sm);
            margin-top: 0.5rem;
        }

        .chart-info.active {
            display: block;
        }

        /* Style the chart containers when hidden */
        .chart-container {
            display: none;
            height: 450px; /* Fixed height for charts */
        }

        .chart-container.active {
            display: block;
        }

        /* Style legends for charts */
        .apexcharts-legend {
            padding: 0.5rem !important;
            border-radius: var(--radius-sm) !important;
            background-color: rgba(var(--content-bg-rgb, 255, 255, 255), 0.8) !important;
        }
        
        body.dark-theme .apexcharts-legend {
            background-color: rgba(var(--content-bg-rgb, 31, 41, 55), 0.8) !important;
        }
        
        .apexcharts-tooltip {
            background-color: var(--content-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
            box-shadow: var(--shadow-md) !important;
        }
    </style>
{% endblock stylesheets %}

{% block content %}
<div class="container-fluid screener-container">
    <!-- Stock Results Header -->
    <div class="stock-results-header">
        <div><strong><i class="fas fa-table me-1"></i> Results:</strong> <span class="badge">{{ stocks|length }}</span> / {{ total_stocks|default:"0" }} Total</div>
        <div class="d-none d-sm-block"> <!-- Hide links on extra small screens -->
            <a href="#" class="save-portfolio"><i class="fas fa-save me-1"></i> Save</a> |
            <a href="#" class="create-alert"><i class="fas fa-bell me-1"></i> Alert</a>
        </div>
        <div class="d-none d-md-block"> <!-- Hide refresh on small screens -->
            <i class="fas fa-sync-alt me-1"></i> Refresh: <strong>3min</strong> | <a href="#" class="refresh-off">off</a>
        </div>
    </div>

    <!-- Header controls section -->
    <div class="screener-header">
        <div class="header-controls">
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="btn-theme-toggle" title="Toggle Theme">
                <i class="fas fa-moon"></i> <!-- Default: Moon icon (Light mode active) -->
            </button>

            <div class="control-group">
                <select id="presets" name="preset" class="control-select">
                    <option value="">My Presets</option>
                    <option value="value">Value Stocks</option>
                    <option value="growth">Growth Stocks</option>
                    <option value="dividend">Dividend Payers</option>
                </select>
            </div>

            <!-- Add view toggle buttons -->
            <div class="view-toggle">
                <button id="table-view-btn" class="active" onclick="toggleView('table')"><i class="fas fa-table"></i> Table</button>
                <button id="chart-view-btn" onclick="toggleView('chart')"><i class="fas fa-chart-pie"></i> Charts</button>
            </div>

            <div class="control-group">
                <span>Order by</span>
                <select id="order-by" name="sort_by" class="control-select">
                    <option value="Symbol" {% if sort_by == 'Symbol' %}selected{% endif %}>Ticker</option>
                    <option value="CompanyName" {% if sort_by == 'CompanyName' %}selected{% endif %}>Company</option>
                    <option value="Sector" {% if sort_by == 'Sector' %}selected{% endif %}>Sector</option>
                    <option value="CurrentPrice" {% if sort_by == 'CurrentPrice' %}selected{% endif %}>Price</option>
                    <option value="ChangePercentage" {% if sort_by == 'ChangePercentage' %}selected{% endif %}>Change %</option>
                    <option value="Volume" {% if sort_by == 'Volume' %}selected{% endif %}>Volume</option>
                    <option value="MarketCap" {% if sort_by == 'MarketCap' %}selected{% endif %}>Market Cap</option>
                    <option value="PE" {% if sort_by == 'PE' %}selected{% endif %}>P/E</option>
                </select>

                <select id="order-direction" name="sort_order" class="control-select">
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Asc</option>
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Desc</option>
                </select>
            </div>

            <div class="control-group">
                <span>Signal</span>
                <select id="signal" name="signal" class="control-select">
                    <option value="none">None</option>
                    <option value="top_gainers">Top Gainers</option>
                    <option value="top_losers">Top Losers</option>
                    <option value="new_high">New High</option>
                    <option value="new_low">New Low</option>
                    <option value="unusual_volume">Unusual Volume</option>
                </select>
            </div>

            <div class="control-group search-group">
                <span>Tickers</span>
                <div class="search-input-group">
                    <input type="text" id="tickers" name="symbol" placeholder="AAPL, MSFT..." value="{{ request.GET.symbol|default:'' }}" class="control-input">
                    <button class="btn-filter" id="search-btn" title="Search Tickers"><i class="fas fa-search"></i></button>
                </div>
            </div>

            <button class="btn-filter" id="show-filters" title="Show/Hide Filters"><i class="fas fa-filter me-1"></i> Filters <i class="fas fa-chevron-down filter-icon"></i></button>
        </div>

        <div class="filter-status">Active Filters: <span id="filter-count" class="badge">{{ filter_count|default:'0' }}</span></div>
    </div>

    <!-- Filter tabs section -->
    <div class="filter-tabs-container" id="filter-tabs-container" style="display: {% if filter_count > 0 %}block{% else %}none{% endif %};">
        <div class="filter-tabs">
            <div class="filter-tab {% if fundamentals_count > 0 or filter_count == 0 %}active{% endif %}" data-tab="fundamentals">Fundamentals {% if fundamentals_count > 0 %}<span class="badge">{{ fundamentals_count }}</span>{% endif %}</div>
            <div class="filter-tab {% if technical_count > 0 %}active{% endif %}" data-tab="technical">Technical {% if technical_count > 0 %}<span class="badge">{{ technical_count }}</span>{% endif %}</div>
            <div class="filter-tab locked {% if performance_count > 0 %}active{% endif %}" data-tab="performance">Performance <i class="fas fa-lock"></i> {% if performance_count > 0 %}<span class="badge">{{ performance_count }}</span>{% endif %}</div>
            <div class="filter-tab locked {% if dividend_count > 0 %}active{% endif %}" data-tab="dividend">Dividend <i class="fas fa-lock"></i> {% if dividend_count > 0 %}<span class="badge">{{ dividend_count }}</span>{% endif %}</div>
            <div class="filter-tab locked {% if ownership_count > 0 %}active{% endif %}" data-tab="ownership">Ownership <i class="fas fa-lock"></i> {% if ownership_count > 0 %}<span class="badge">{{ ownership_count }}</span>{% endif %}</div>
        </div>

        <!-- Filter sections -->
        <div class="filter-section" id="filter-section">
            <!-- Fundamentals tab content -->
            <div id="fundamentals-filters" class="filter-content{% if fundamentals_count > 0 %} active{% elif filter_count == 0 %} active{% endif %}">
                <div class="filter-count-header">
                    <span>Fundamentals Filters: <span id="fundamental-filter-count">{{ fundamentals_count }}</span></span>
                    <button class="btn-reset" data-target-tab="fundamentals">Reset Fundamentals</button>
                </div>
                <div class="filter-grid">
                    <div class="filter-cell">
                        <div class="filter-label">Exchange</div>
                        <div class="filter-value">
                            <select name="exchange" class="filter-select">
                                <option value="any" {% if filter_params.exchange == 'any' %}selected{% endif %}>Any</option>
                                <option value="PSX" {% if filter_params.exchange == 'PSX' %}selected{% endif %}>PSX</option>
                                <option value="ISE" {% if filter_params.exchange == 'ISE' %}selected{% endif %}>ISE</option>
                                <option value="NASDAQ" {% if filter_params.exchange == 'NASDAQ' %}selected{% endif %}>NASDAQ</option>
                                <option value="NYSE" {% if filter_params.exchange == 'NYSE' %}selected{% endif %}>NYSE</option>
                                <option value="AMEX" {% if filter_params.exchange == 'AMEX' %}selected{% endif %}>AMEX</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Index</div>
                        <div class="filter-value">
                            <select name="index" class="filter-select">
                                <option value="any" {% if filter_params.index == 'any' %}selected{% endif %}>Any</option>
                                <option value="KSE100" {% if filter_params.index == 'KSE100' %}selected{% endif %}>KSE-100</option>
                                <option value="KSE30" {% if filter_params.index == 'KSE30' %}selected{% endif %}>KSE-30</option>
                                <option value="KMI30" {% if filter_params.index == 'KMI30' %}selected{% endif %}>KMI-30</option>
                                <option value="DJIA" {% if filter_params.index == 'DJIA' %}selected{% endif %}>DJIA</option>
                                <option value="SP500" {% if filter_params.index == 'SP500' %}selected{% endif %}>S&P 500</option>
                                <option value="NASDAQ100" {% if filter_params.index == 'NASDAQ100' %}selected{% endif %}>NASDAQ 100</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Sector</div>
                        <div class="filter-value">
                            <select name="sector" class="filter-select">
                                <option value="any" {% if filter_params.sector == 'any' %}selected{% endif %}>Any</option>
                                {% for sector in sectors %}
                                <option value="{{ sector }}" {% if filter_params.sector == sector %}selected{% endif %}>{{ sector }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Industry</div>
                        <div class="filter-value">
                            <select name="industry" class="filter-select">
                                <option value="any" {% if filter_params.industry == 'any' %}selected{% endif %}>Any</option>
                                {% for industry in industries %}
                                <option value="{{ industry }}" {% if filter_params.industry == industry %}selected{% endif %}>{{ industry }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Country</div>
                        <div class="filter-value">
                            <select name="country" class="filter-select">
                                <option value="any" {% if filter_params.country == 'any' %}selected{% endif %}>Any</option>
                                {% for country in countries %}
                                <option value="{{ country }}" {% if filter_params.country == country %}selected{% endif %}>{{ country }}</option>
                                {% endfor %}
                                <option value="USA" {% if filter_params.country == 'USA' %}selected{% endif %}>USA</option>
                                <option value="Pakistan" {% if filter_params.country == 'Pakistan' %}selected{% endif %}>Pakistan</option>
                                <option value="Canada" {% if filter_params.country == 'Canada' %}selected{% endif %}>Canada</option>
                                <option value="China" {% if filter_params.country == 'China' %}selected{% endif %}>China</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Market Cap.</div>
                        <div class="filter-value">
                            <select name="market_cap" class="filter-select">
                                <option value="any" {% if filter_params.market_cap == 'any' %}selected{% endif %}>Any</option>
                                <option value="Mega" {% if filter_params.market_cap == 'Mega' %}selected{% endif %}>Mega (+$200B)</option>
                                <option value="Large" {% if filter_params.market_cap == 'Large' %}selected{% endif %}>Large (+$10B)</option>
                                <option value="Mid" {% if filter_params.market_cap == 'Mid' %}selected{% endif %}>Mid (+$2B)</option>
                                <option value="Small" {% if filter_params.market_cap == 'Small' %}selected{% endif %}>Small (+$300M)</option>
                                <option value="Micro" {% if filter_params.market_cap == 'Micro' %}selected{% endif %}>Micro (+$50M)</option>
                                <option value="Nano" {% if filter_params.market_cap == 'Nano' %}selected{% endif %}>Nano (-$50M)</option>
                                <option value="-Mega" {% if filter_params.market_cap == '-Mega' %}selected{% endif %}>Not Mega (-$200B)</option>
                                <option value="-Large" {% if filter_params.market_cap == '-Large' %}selected{% endif %}>Not Large (-$10B)</option>
                                <option value="-Mid" {% if filter_params.market_cap == '-Mid' %}selected{% endif %}>Not Mid (-$2B)</option>
                                <option value="-Small" {% if filter_params.market_cap == '-Small' %}selected{% endif %}>Not Small (-$300M)</option>
                                <option value="-Micro" {% if filter_params.market_cap == '-Micro' %}selected{% endif %}>Not Micro (-$50M)</option>
                                <option value="Over 1B" {% if filter_params.market_cap == 'Over 1B' %}selected{% endif %}>Over 1B</option>
                                <option value="Over 5B" {% if filter_params.market_cap == 'Over 5B' %}selected{% endif %}>Over 5B</option>
                                <option value="Over 10B" {% if filter_params.market_cap == 'Over 10B' %}selected{% endif %}>Over 10B</option>
                                <option value="Over 50B" {% if filter_params.market_cap == 'Over 50B' %}selected{% endif %}>Over 50B</option>
                                <option value="Over 100B" {% if filter_params.market_cap == 'Over 100B' %}selected{% endif %}>Over 100B</option>
                                <option value="Over 200B" {% if filter_params.market_cap == 'Over 200B' %}selected{% endif %}>Over 200B</option>
                                <option value="Under 1B" {% if filter_params.market_cap == 'Under 1B' %}selected{% endif %}>Under 1B</option>
                                <option value="Under 5B" {% if filter_params.market_cap == 'Under 5B' %}selected{% endif %}>Under 5B</option>
                                <option value="Under 10B" {% if filter_params.market_cap == 'Under 10B' %}selected{% endif %}>Under 10B</option>
                                <option value="Under 50B" {% if filter_params.market_cap == 'Under 50B' %}selected{% endif %}>Under 50B</option>
                                <option value="Under 100B" {% if filter_params.market_cap == 'Under 100B' %}selected{% endif %}>Under 100B</option>
                                <option value="Under 200B" {% if filter_params.market_cap == 'Under 200B' %}selected{% endif %}>Under 200B</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Dividend Yield</div>
                        <div class="filter-value">
                            <select name="div_yield" class="filter-select">
                                <option value="any" {% if filter_params.div_yield == 'any' %}selected{% endif %}>Any</option>
                                <option value="None" {% if filter_params.div_yield == 'None' %}selected{% endif %}>None (0%)</option>
                                <option value="Positive" {% if filter_params.div_yield == 'Positive' %}selected{% endif %}>Positive (>0%)</option>
                                <option value="High" {% if filter_params.div_yield == 'High' %}selected{% endif %}>High (>5%)</option>
                                <option value="Very High" {% if filter_params.div_yield == 'Very High' %}selected{% endif %}>Very High (>10%)</option>
                                <option value="Over 1%" {% if filter_params.div_yield == 'Over 1%' %}selected{% endif %}>Over 1%</option>
                                <option value="Over 2%" {% if filter_params.div_yield == 'Over 2%' %}selected{% endif %}>Over 2%</option>
                                <option value="Over 3%" {% if filter_params.div_yield == 'Over 3%' %}selected{% endif %}>Over 3%</option>
                                <option value="Over 4%" {% if filter_params.div_yield == 'Over 4%' %}selected{% endif %}>Over 4%</option>
                                <option value="Over 5%" {% if filter_params.div_yield == 'Over 5%' %}selected{% endif %}>Over 5%</option>
                                <option value="Over 6%" {% if filter_params.div_yield == 'Over 6%' %}selected{% endif %}>Over 6%</option>
                                <option value="Over 7%" {% if filter_params.div_yield == 'Over 7%' %}selected{% endif %}>Over 7%</option>
                                <option value="Over 8%" {% if filter_params.div_yield == 'Over 8%' %}selected{% endif %}>Over 8%</option>
                                <option value="Over 9%" {% if filter_params.div_yield == 'Over 9%' %}selected{% endif %}>Over 9%</option>
                                <option value="Over 10%" {% if filter_params.div_yield == 'Over 10%' %}selected{% endif %}>Over 10%</option>
                                <option value="Under 1%" {% if filter_params.div_yield == 'Under 1%' %}selected{% endif %}>Under 1%</option>
                                <option value="Under 2%" {% if filter_params.div_yield == 'Under 2%' %}selected{% endif %}>Under 2%</option>
                                <option value="Under 3%" {% if filter_params.div_yield == 'Under 3%' %}selected{% endif %}>Under 3%</option>
                                <option value="Under 4%" {% if filter_params.div_yield == 'Under 4%' %}selected{% endif %}>Under 4%</option>
                                <option value="Under 5%" {% if filter_params.div_yield == 'Under 5%' %}selected{% endif %}>Under 5%</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Price (PKR)</div>
                        <div class="filter-value">
                            <select name="price" class="filter-select">
                                <option value="any" {% if filter_params.price == 'any' %}selected{% endif %}>Any</option>
                                <option value="Under PKR10" {% if filter_params.price == 'Under PKR10' %}selected{% endif %}>Under PKR10</option>
                                <option value="Under PKR50" {% if filter_params.price == 'Under PKR50' %}selected{% endif %}>Under PKR50</option>
                                <option value="Under PKR100" {% if filter_params.price == 'Under PKR100' %}selected{% endif %}>Under PKR100</option>
                                <option value="Under PKR200" {% if filter_params.price == 'Under PKR200' %}selected{% endif %}>Under PKR200</option>
                                <option value="Under PKR500" {% if filter_params.price == 'Under PKR500' %}selected{% endif %}>Under PKR500</option>
                                <option value="Under PKR1000" {% if filter_params.price == 'Under PKR1000' %}selected{% endif %}>Under PKR1000</option>
                                <option value="Over PKR10" {% if filter_params.price == 'Over PKR10' %}selected{% endif %}>Over PKR10</option>
                                <option value="Over PKR50" {% if filter_params.price == 'Over PKR50' %}selected{% endif %}>Over PKR50</option>
                                <option value="Over PKR100" {% if filter_params.price == 'Over PKR100' %}selected{% endif %}>Over PKR100</option>
                                <option value="Over PKR200" {% if filter_params.price == 'Over PKR200' %}selected{% endif %}>Over PKR200</option>
                                <option value="Over PKR500" {% if filter_params.price == 'Over PKR500' %}selected{% endif %}>Over PKR500</option>
                                <option value="Over PKR1000" {% if filter_params.price == 'Over PKR1000' %}selected{% endif %}>Over PKR1000</option>
                                <option value="PKR10 to PKR50" {% if filter_params.price == 'PKR10 to PKR50' %}selected{% endif %}>PKR10 to PKR50</option>
                                <option value="PKR50 to PKR100" {% if filter_params.price == 'PKR50 to PKR100' %}selected{% endif %}>PKR50 to PKR100</option>
                                <option value="PKR100 to PKR200" {% if filter_params.price == 'PKR100 to PKR200' %}selected{% endif %}>PKR100 to PKR200</option>
                                <option value="PKR200 to PKR500" {% if filter_params.price == 'PKR200 to PKR500' %}selected{% endif %}>PKR200 to PKR500</option>
                                <option value="PKR500 to PKR1000" {% if filter_params.price == 'PKR500 to PKR1000' %}selected{% endif %}>PKR500 to PKR1000</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Volume</div>
                        <div class="filter-value">
                            <select name="current_volume" class="filter-select">
                                <option value="any" {% if filter_params.current_volume == 'any' %}selected{% endif %}>Any</option>
                                <option value="Under 50K" {% if filter_params.current_volume == 'Under 50K' %}selected{% endif %}>Under 50K</option>
                                <option value="Under 100K" {% if filter_params.current_volume == 'Under 100K' %}selected{% endif %}>Under 100K</option>
                                <option value="Under 500K" {% if filter_params.current_volume == 'Under 500K' %}selected{% endif %}>Under 500K</option>
                                <option value="Under 1M" {% if filter_params.current_volume == 'Under 1M' %}selected{% endif %}>Under 1M</option>
                                <option value="Over 50K" {% if filter_params.current_volume == 'Over 50K' %}selected{% endif %}>Over 50K</option>
                                <option value="Over 100K" {% if filter_params.current_volume == 'Over 100K' %}selected{% endif %}>Over 100K</option>
                                <option value="Over 500K" {% if filter_params.current_volume == 'Over 500K' %}selected{% endif %}>Over 500K</option>
                                <option value="Over 1M" {% if filter_params.current_volume == 'Over 1M' %}selected{% endif %}>Over 1M</option>
                                <option value="Over 5M" {% if filter_params.current_volume == 'Over 5M' %}selected{% endif %}>Over 5M</option>
                                <option value="Over 10M" {% if filter_params.current_volume == 'Over 10M' %}selected{% endif %}>Over 10M</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Relative Volume</div>
                        <div class="filter-value">
                            <select name="rel_volume" class="filter-select">
                                <option value="any" {% if filter_params.rel_volume == 'any' %}selected{% endif %}>Any</option>
                                <option value="Over 0.5" {% if filter_params.rel_volume == 'Over 0.5' %}selected{% endif %}>Over 0.5</option>
                                <option value="Over 1" {% if filter_params.rel_volume == 'Over 1' %}selected{% endif %}>Over 1</option>
                                <option value="Over 1.5" {% if filter_params.rel_volume == 'Over 1.5' %}selected{% endif %}>Over 1.5</option>
                                <option value="Over 2" {% if filter_params.rel_volume == 'Over 2' %}selected{% endif %}>Over 2</option>
                                <option value="Over 3" {% if filter_params.rel_volume == 'Over 3' %}selected{% endif %}>Over 3</option>
                                <option value="Over 5" {% if filter_params.rel_volume == 'Over 5' %}selected{% endif %}>Over 5</option>
                                <option value="Over 10" {% if filter_params.rel_volume == 'Over 10' %}selected{% endif %}>Over 10</option>
                                <option value="Under 0.5" {% if filter_params.rel_volume == 'Under 0.5' %}selected{% endif %}>Under 0.5</option>
                                <option value="Under 1" {% if filter_params.rel_volume == 'Under 1' %}selected{% endif %}>Under 1</option>
                                <option value="Under 1.5" {% if filter_params.rel_volume == 'Under 1.5' %}selected{% endif %}>Under 1.5</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-cell">
                        <div class="filter-label">Float</div>
                        <div class="filter-value">
                            <select name="float" class="filter-select">
                                <option value="any" {% if filter_params.float == 'any' %}selected{% endif %}>Any</option>
                                <option value="Under 1M" {% if filter_params.float == 'Under 1M' %}selected{% endif %}>Under 1M</option>
                                <option value="Under 5M" {% if filter_params.float == 'Under 5M' %}selected{% endif %}>Under 5M</option>
                                <option value="Under 10M" {% if filter_params.float == 'Under 10M' %}selected{% endif %}>Under 10M</option>
                                <option value="Under 50M" {% if filter_params.float == 'Under 50M' %}selected{% endif %}>Under 50M</option>
                                <option value="Under 100M" {% if filter_params.float == 'Under 100M' %}selected{% endif %}>Under 100M</option>
                                <option value="Over 1M" {% if filter_params.float == 'Over 1M' %}selected{% endif %}>Over 1M</option>
                                <option value="Over 5M" {% if filter_params.float == 'Over 5M' %}selected{% endif %}>Over 5M</option>
                                <option value="Over 10M" {% if filter_params.float == 'Over 10M' %}selected{% endif %}>Over 10M</option>
                                <option value="Over 50M" {% if filter_params.float == 'Over 50M' %}selected{% endif %}>Over 50M</option>
                                <option value="Over 100M" {% if filter_params.float == 'Over 100M' %}selected{% endif %}>Over 100M</option>
                                <option value="Over 500M" {% if filter_params.float == 'Over 500M' %}selected{% endif %}>Over 500M</option>
                                <option value="Over 1B" {% if filter_params.float == 'Over 1B' %}selected{% endif %}>Over 1B</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technical tab content -->
            <div id="technical-filters" class="filter-content{% if technical_count > 0 %} active{% endif %}" {% if technical_count == 0 and fundamentals_count > 0 %}style="display: none;"{% elif technical_count == 0 and filter_count == 0 %}style="display: none;"{% endif %}>
                <div class="filter-count-header">
                    <span>Technical Filters: <span id="technical-filter-count">{{ technical_count }}</span></span>
                    <button class="btn-reset" data-target-tab="technical">Reset Technical</button>
                </div>
                <div class="filter-grid">
                    <div class="filter-cell">
                        <div class="filter-label">P/E (Price/Earnings TTM)</div>
                        <div class="filter-value">
                            <select name="pe_ratio" class="filter-select">
                                <option value="any" {% if filter_params.pe_ratio == 'any' %}selected{% endif %}>Any</option>
                                <option value="Low (<15)" {% if filter_params.pe_ratio == 'Low (<15)' %}selected{% endif %}>Low (&lt;15)</option>
                                <option value="Profitable (>0)" {% if filter_params.pe_ratio == 'Profitable (>0)' %}selected{% endif %}>Profitable (&gt;0)</option>
                                <option value="High (>50)" {% if filter_params.pe_ratio == 'High (>50)' %}selected{% endif %}>High (&gt;50)</option>
                                <option value="Under 5" {% if filter_params.pe_ratio == 'Under 5' %}selected{% endif %}>Under 5</option>
                                <option value="Under 10" {% if filter_params.pe_ratio == 'Under 10' %}selected{% endif %}>Under 10</option>
                                <option value="Under 15" {% if filter_params.pe_ratio == 'Under 15' %}selected{% endif %}>Under 15</option>
                                <option value="Under 20" {% if filter_params.pe_ratio == 'Under 20' %}selected{% endif %}>Under 20</option>
                                <option value="Under 25" {% if filter_params.pe_ratio == 'Under 25' %}selected{% endif %}>Under 25</option>
                                <option value="Under 30" {% if filter_params.pe_ratio == 'Under 30' %}selected{% endif %}>Under 30</option>
                                <option value="Under 35" {% if filter_params.pe_ratio == 'Under 35' %}selected{% endif %}>Under 35</option>
                                <option value="Under 40" {% if filter_params.pe_ratio == 'Under 40' %}selected{% endif %}>Under 40</option>
                                <option value="Under 45" {% if filter_params.pe_ratio == 'Under 45' %}selected{% endif %}>Under 45</option>
                                <option value="Under 50" {% if filter_params.pe_ratio == 'Under 50' %}selected{% endif %}>Under 50</option>
                                <option value="Over 5" {% if filter_params.pe_ratio == 'Over 5' %}selected{% endif %}>Over 5</option>
                                <option value="Over 10" {% if filter_params.pe_ratio == 'Over 10' %}selected{% endif %}>Over 10</option>
                                <option value="Over 15" {% if filter_params.pe_ratio == 'Over 15' %}selected{% endif %}>Over 15</option>
                                <option value="Over 20" {% if filter_params.pe_ratio == 'Over 20' %}selected{% endif %}>Over 20</option>
                                <option value="Over 25" {% if filter_params.pe_ratio == 'Over 25' %}selected{% endif %}>Over 25</option>
                                <option value="Over 30" {% if filter_params.pe_ratio == 'Over 30' %}selected{% endif %}>Over 30</option>
                                <option value="Over 35" {% if filter_params.pe_ratio == 'Over 35' %}selected{% endif %}>Over 35</option>
                                <option value="Over 40" {% if filter_params.pe_ratio == 'Over 40' %}selected{% endif %}>Over 40</option>
                                <option value="Over 45" {% if filter_params.pe_ratio == 'Over 45' %}selected{% endif %}>Over 45</option>
                                <option value="Over 50" {% if filter_params.pe_ratio == 'Over 50' %}selected{% endif %}>Over 50</option>
                                <option value="Over 60" {% if filter_params.pe_ratio == 'Over 60' %}selected{% endif %}>Over 60</option>
                                <option value="Over 70" {% if filter_params.pe_ratio == 'Over 70' %}selected{% endif %}>Over 70</option>
                                <option value="Over 80" {% if filter_params.pe_ratio == 'Over 80' %}selected{% endif %}>Over 80</option>
                                <option value="Over 90" {% if filter_params.pe_ratio == 'Over 90' %}selected{% endif %}>Over 90</option>
                                <option value="Over 100" {% if filter_params.pe_ratio == 'Over 100' %}selected{% endif %}>Over 100</option>
                                <option value="Negative (<0)" {% if filter_params.pe_ratio == 'Negative (<0)' %}selected{% endif %}>Negative (&lt;0)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell">
                        <div class="filter-label">P/B (Price to Book Ratio)</div>
                        <div class="filter-value">
                            <select name="pb_ratio" class="filter-select">
                                <option value="any" {% if filter_params.pb_ratio == 'any' %}selected{% endif %}>Any</option>
                                <option value="Under 1" {% if filter_params.pb_ratio == 'Under 1' %}selected{% endif %}>Under 1 (Undervalued)</option>
                                <option value="Under 2" {% if filter_params.pb_ratio == 'Under 2' %}selected{% endif %}>Under 2</option>
                                <option value="Under 3" {% if filter_params.pb_ratio == 'Under 3' %}selected{% endif %}>Under 3</option>
                                <option value="Under 5" {% if filter_params.pb_ratio == 'Under 5' %}selected{% endif %}>Under 5</option>
                                <option value="Over 1" {% if filter_params.pb_ratio == 'Over 1' %}selected{% endif %}>Over 1</option>
                                <option value="Over 2" {% if filter_params.pb_ratio == 'Over 2' %}selected{% endif %}>Over 2</option>
                                <option value="Over 3" {% if filter_params.pb_ratio == 'Over 3' %}selected{% endif %}>Over 3</option>
                                <option value="Over 5" {% if filter_params.pb_ratio == 'Over 5' %}selected{% endif %}>Over 5</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell">
                        <div class="filter-label">52-Week Range</div>
                        <div class="filter-value">
                            <select name="year_range" class="filter-select">
                                <option value="any" {% if filter_params.year_range == 'any' %}selected{% endif %}>Any</option>
                                <option value="Near High" {% if filter_params.year_range == 'Near High' %}selected{% endif %}>Near High (90%+)</option>
                                <option value="Near Low" {% if filter_params.year_range == 'Near Low' %}selected{% endif %}>Near Low (within 10%)</option>
                                <option value="New High" {% if filter_params.year_range == 'New High' %}selected{% endif %}>New High</option>
                                <option value="New Low" {% if filter_params.year_range == 'New Low' %}selected{% endif %}>New Low</option>
                                <option value="Upper Half" {% if filter_params.year_range == 'Upper Half' %}selected{% endif %}>Upper Half</option>
                                <option value="Lower Half" {% if filter_params.year_range == 'Lower Half' %}selected{% endif %}>Lower Half</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell">
                        <div class="filter-label">RSI (14)</div>
                        <div class="filter-value">
                            <select name="rsi" class="filter-select">
                                <option value="any" {% if filter_params.rsi == 'any' %}selected{% endif %}>Any</option>
                                <option value="Overbought (>70)" {% if filter_params.rsi == 'Overbought (>70)' %}selected{% endif %}>Overbought (&gt;70)</option>
                                <option value="Oversold (<30)" {% if filter_params.rsi == 'Oversold (<30)' %}selected{% endif %}>Oversold (&lt;30)</option>
                                <option value="Over 80" {% if filter_params.rsi == 'Over 80' %}selected{% endif %}>Over 80 (Extremely Overbought)</option>
                                <option value="Under 20" {% if filter_params.rsi == 'Under 20' %}selected{% endif %}>Under 20 (Extremely Oversold)</option>
                                <option value="Between 40-60" {% if filter_params.rsi == 'Between 40-60' %}selected{% endif %}>Between 40-60 (Neutral)</option>
                                <option value="Between 50-70" {% if filter_params.rsi == 'Between 50-70' %}selected{% endif %}>Between 50-70 (Bullish)</option>
                                <option value="Between 30-50" {% if filter_params.rsi == 'Between 30-50' %}selected{% endif %}>Between 30-50 (Bearish)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell">
                        <div class="filter-label">Moving Average (50-day)</div>
                        <div class="filter-value">
                            <select name="ma_50" class="filter-select">
                                <option value="any" {% if filter_params.ma_50 == 'any' %}selected{% endif %}>Any</option>
                                <option value="Price Above MA" {% if filter_params.ma_50 == 'Price Above MA' %}selected{% endif %}>Price Above MA</option>
                                <option value="Price Below MA" {% if filter_params.ma_50 == 'Price Below MA' %}selected{% endif %}>Price Below MA</option>
                                <option value="Price 10% Above MA" {% if filter_params.ma_50 == 'Price 10% Above MA' %}selected{% endif %}>Price 10% Above MA</option>
                                <option value="Price 10% Below MA" {% if filter_params.ma_50 == 'Price 10% Below MA' %}selected{% endif %}>Price 10% Below MA</option>
                                <option value="MA Rising" {% if filter_params.ma_50 == 'MA Rising' %}selected{% endif %}>MA Rising</option>
                                <option value="MA Falling" {% if filter_params.ma_50 == 'MA Falling' %}selected{% endif %}>MA Falling</option>
                                <option value="Crossed Above" {% if filter_params.ma_50 == 'Crossed Above' %}selected{% endif %}>Crossed Above (Recently)</option>
                                <option value="Crossed Below" {% if filter_params.ma_50 == 'Crossed Below' %}selected{% endif %}>Crossed Below (Recently)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell">
                        <div class="filter-label">Moving Average (200-day)</div>
                        <div class="filter-value">
                            <select name="ma_200" class="filter-select">
                                <option value="any" {% if filter_params.ma_200 == 'any' %}selected{% endif %}>Any</option>
                                <option value="Price Above MA" {% if filter_params.ma_200 == 'Price Above MA' %}selected{% endif %}>Price Above MA</option>
                                <option value="Price Below MA" {% if filter_params.ma_200 == 'Price Below MA' %}selected{% endif %}>Price Below MA</option>
                                <option value="Price 10% Above MA" {% if filter_params.ma_200 == 'Price 10% Above MA' %}selected{% endif %}>Price 10% Above MA</option>
                                <option value="Price 10% Below MA" {% if filter_params.ma_200 == 'Price 10% Below MA' %}selected{% endif %}>Price 10% Below MA</option>
                                <option value="MA Rising" {% if filter_params.ma_200 == 'MA Rising' %}selected{% endif %}>MA Rising</option>
                                <option value="MA Falling" {% if filter_params.ma_200 == 'MA Falling' %}selected{% endif %}>MA Falling</option>
                                <option value="Crossed Above" {% if filter_params.ma_200 == 'Crossed Above' %}selected{% endif %}>Crossed Above (Recently)</option>
                                <option value="Crossed Below" {% if filter_params.ma_200 == 'Crossed Below' %}selected{% endif %}>Crossed Below (Recently)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell">
                        <div class="filter-label">Volume Trend</div>
                        <div class="filter-value">
                            <select name="volume_trend" class="filter-select">
                                <option value="any" {% if filter_params.volume_trend == 'any' %}selected{% endif %}>Any</option>
                                <option value="Increasing" {% if filter_params.volume_trend == 'Increasing' %}selected{% endif %}>Increasing</option>
                                <option value="Decreasing" {% if filter_params.volume_trend == 'Decreasing' %}selected{% endif %}>Decreasing</option>
                                <option value="Above Average" {% if filter_params.volume_trend == 'Above Average' %}selected{% endif %}>Above Average</option>
                                <option value="Below Average" {% if filter_params.volume_trend == 'Below Average' %}selected{% endif %}>Below Average</option>
                                <option value="Unusual High" {% if filter_params.volume_trend == 'Unusual High' %}selected{% endif %}>Unusual High (3x Avg)</option>
                                <option value="Unusual Low" {% if filter_params.volume_trend == 'Unusual Low' %}selected{% endif %}>Unusual Low (1/3x Avg)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell">
                        <div class="filter-label">Price/Sales Ratio</div>
                        <div class="filter-value">
                            <select name="ps_ratio" class="filter-select">
                                <option value="any" {% if filter_params.ps_ratio == 'any' %}selected{% endif %}>Any</option>
                                <option value="Under 1" {% if filter_params.ps_ratio == 'Under 1' %}selected{% endif %}>Under 1</option>
                                <option value="Under 2" {% if filter_params.ps_ratio == 'Under 2' %}selected{% endif %}>Under 2</option>
                                <option value="Under 3" {% if filter_params.ps_ratio == 'Under 3' %}selected{% endif %}>Under 3</option>
                                <option value="Under 5" {% if filter_params.ps_ratio == 'Under 5' %}selected{% endif %}>Under 5</option>
                                <option value="Over 1" {% if filter_params.ps_ratio == 'Over 1' %}selected{% endif %}>Over 1</option>
                                <option value="Over 2" {% if filter_params.ps_ratio == 'Over 2' %}selected{% endif %}>Over 2</option>
                                <option value="Over 5" {% if filter_params.ps_ratio == 'Over 5' %}selected{% endif %}>Over 5</option>
                                <option value="Over 10" {% if filter_params.ps_ratio == 'Over 10' %}selected{% endif %}>Over 10</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance tab content -->
            <div id="performance-filters" class="filter-content locked{% if performance_count > 0 %} active{% endif %}" {% if performance_count == 0 %}style="display: none;"{% endif %}>
                <div class="filter-count-header">
                    <span>Performance Filters: <span id="performance-filter-count">{{ performance_count }}</span> <i class="fas fa-lock"></i></span>
                    <button class="btn-reset" data-target-tab="performance">Reset Performance</button>
                </div>
                <div class="filter-grid">
                    <div class="filter-cell locked">
                        <div class="filter-label">Performance (Day)</div>
                        <div class="filter-value">
                            <select name="perf_day" class="filter-select">
                                <option value="any" {% if filter_params.perf_day == 'any' %}selected{% endif %}>Any</option>
                                <option value="Up" {% if filter_params.perf_day == 'Up' %}selected{% endif %}>Up</option>
                                <option value="Down" {% if filter_params.perf_day == 'Down' %}selected{% endif %}>Down</option>
                                <option value="Up1%" {% if filter_params.perf_day == 'Up1%' %}selected{% endif %}>Up 1%+</option>
                                <option value="Down1%" {% if filter_params.perf_day == 'Down1%' %}selected{% endif %}>Down 1%+</option>
                                <option value="Up2%" {% if filter_params.perf_day == 'Up2%' %}selected{% endif %}>Up 2%+</option>
                                <option value="Down2%" {% if filter_params.perf_day == 'Down2%' %}selected{% endif %}>Down 2%+</option>
                                <option value="Up5%" {% if filter_params.perf_day == 'Up5%' %}selected{% endif %}>Up 5%+</option>
                                <option value="Down5%" {% if filter_params.perf_day == 'Down5%' %}selected{% endif %}>Down 5%+</option>
                                <option value="Up10%" {% if filter_params.perf_day == 'Up10%' %}selected{% endif %}>Up 10%+</option>
                                <option value="Down10%" {% if filter_params.perf_day == 'Down10%' %}selected{% endif %}>Down 10%+</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell locked">
                        <div class="filter-label">Performance (Week)</div>
                        <div class="filter-value">
                            <select name="perf_week" class="filter-select">
                                <option value="any" {% if filter_params.perf_week == 'any' %}selected{% endif %}>Any</option>
                                <option value="Up" {% if filter_params.perf_week == 'Up' %}selected{% endif %}>Up</option>
                                <option value="Down" {% if filter_params.perf_week == 'Down' %}selected{% endif %}>Down</option>
                                <option value="Up5%" {% if filter_params.perf_week == 'Up5%' %}selected{% endif %}>Up 5%+</option>
                                <option value="Down5%" {% if filter_params.perf_week == 'Down5%' %}selected{% endif %}>Down 5%+</option>
                                <option value="Up10%" {% if filter_params.perf_week == 'Up10%' %}selected{% endif %}>Up 10%+</option>
                                <option value="Down10%" {% if filter_params.perf_week == 'Down10%' %}selected{% endif %}>Down 10%+</option>
                                <option value="Up15%" {% if filter_params.perf_week == 'Up15%' %}selected{% endif %}>Up 15%+</option>
                                <option value="Down15%" {% if filter_params.perf_week == 'Down15%' %}selected{% endif %}>Down 15%+</option>
                                <option value="Up20%" {% if filter_params.perf_week == 'Up20%' %}selected{% endif %}>Up 20%+</option>
                                <option value="Down20%" {% if filter_params.perf_week == 'Down20%' %}selected{% endif %}>Down 20%+</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell locked">
                        <div class="filter-label">Performance (Month)</div>
                        <div class="filter-value">
                            <select name="perf_month" class="filter-select">
                                <option value="any" {% if filter_params.perf_month == 'any' %}selected{% endif %}>Any</option>
                                <option value="Up" {% if filter_params.perf_month == 'Up' %}selected{% endif %}>Up</option>
                                <option value="Down" {% if filter_params.perf_month == 'Down' %}selected{% endif %}>Down</option>
                                <option value="Up10%" {% if filter_params.perf_month == 'Up10%' %}selected{% endif %}>Up 10%+</option>
                                <option value="Down10%" {% if filter_params.perf_month == 'Down10%' %}selected{% endif %}>Down 10%+</option>
                                <option value="Up20%" {% if filter_params.perf_month == 'Up20%' %}selected{% endif %}>Up 20%+</option>
                                <option value="Down20%" {% if filter_params.perf_month == 'Down20%' %}selected{% endif %}>Down 20%+</option>
                                <option value="Up30%" {% if filter_params.perf_month == 'Up30%' %}selected{% endif %}>Up 30%+</option>
                                <option value="Down30%" {% if filter_params.perf_month == 'Down30%' %}selected{% endif %}>Down 30%+</option>
                                <option value="Up50%" {% if filter_params.perf_month == 'Up50%' %}selected{% endif %}>Up 50%+</option>
                                <option value="Down50%" {% if filter_params.perf_month == 'Down50%' %}selected{% endif %}>Down 50%+</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dividend tab content -->
            <div id="dividend-filters" class="filter-content locked{% if dividend_count > 0 %} active{% endif %}" {% if dividend_count == 0 %}style="display: none;"{% endif %}>
                <div class="filter-count-header">
                    <span>Dividend Filters: <span id="dividend-filter-count">{{ dividend_count }}</span> <i class="fas fa-lock"></i></span>
                    <button class="btn-reset" data-target-tab="dividend">Reset Dividend</button>
                </div>
                <div class="filter-grid">
                    <div class="filter-cell locked">
                        <div class="filter-label">Dividend Yield</div>
                        <div class="filter-value">
                            <select name="div_yield" class="filter-select">
                                <option value="any" {% if filter_params.div_yield == 'any' %}selected{% endif %}>Any</option>
                                <option value="None" {% if filter_params.div_yield == 'None' %}selected{% endif %}>None (0%)</option>
                                <option value="Positive" {% if filter_params.div_yield == 'Positive' %}selected{% endif %}>Positive (>0%)</option>
                                <option value="High" {% if filter_params.div_yield == 'High' %}selected{% endif %}>High (>5%)</option>
                                <option value="Very High" {% if filter_params.div_yield == 'Very High' %}selected{% endif %}>Very High (>10%)</option>
                                <option value="Over 1%" {% if filter_params.div_yield == 'Over 1%' %}selected{% endif %}>Over 1%</option>
                                <option value="Over 2%" {% if filter_params.div_yield == 'Over 2%' %}selected{% endif %}>Over 2%</option>
                                <option value="Over 3%" {% if filter_params.div_yield == 'Over 3%' %}selected{% endif %}>Over 3%</option>
                                <option value="Over 4%" {% if filter_params.div_yield == 'Over 4%' %}selected{% endif %}>Over 4%</option>
                                <option value="Over 5%" {% if filter_params.div_yield == 'Over 5%' %}selected{% endif %}>Over 5%</option>
                                <option value="Over 6%" {% if filter_params.div_yield == 'Over 6%' %}selected{% endif %}>Over 6%</option>
                                <option value="Over 7%" {% if filter_params.div_yield == 'Over 7%' %}selected{% endif %}>Over 7%</option>
                                <option value="Over 8%" {% if filter_params.div_yield == 'Over 8%' %}selected{% endif %}>Over 8%</option>
                                <option value="Over 9%" {% if filter_params.div_yield == 'Over 9%' %}selected{% endif %}>Over 9%</option>
                                <option value="Over 10%" {% if filter_params.div_yield == 'Over 10%' %}selected{% endif %}>Over 10%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell locked">
                        <div class="filter-label">Dividend Frequency</div>
                        <div class="filter-value">
                            <select name="div_frequency" class="filter-select">
                                <option value="any" {% if filter_params.div_frequency == 'any' %}selected{% endif %}>Any</option>
                                <option value="Annual" {% if filter_params.div_frequency == 'Annual' %}selected{% endif %}>Annual</option>
                                <option value="Semi-Annual" {% if filter_params.div_frequency == 'Semi-Annual' %}selected{% endif %}>Semi-Annual</option>
                                <option value="Quarterly" {% if filter_params.div_frequency == 'Quarterly' %}selected{% endif %}>Quarterly</option>
                                <option value="Monthly" {% if filter_params.div_frequency == 'Monthly' %}selected{% endif %}>Monthly</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ownership tab content -->
            <div id="ownership-filters" class="filter-content locked{% if ownership_count > 0 %} active{% endif %}" {% if ownership_count == 0 %}style="display: none;"{% endif %}>
                <div class="filter-count-header">
                    <span>Ownership Filters: <span id="ownership-filter-count">{{ ownership_count }}</span> <i class="fas fa-lock"></i></span>
                    <button class="btn-reset" data-target-tab="ownership">Reset Ownership</button>
                </div>
                <div class="filter-grid">
                    <div class="filter-cell locked">
                        <div class="filter-label">Institutional Ownership</div>
                        <div class="filter-value">
                            <select name="inst_ownership" class="filter-select">
                                <option value="any" {% if filter_params.inst_ownership == 'any' %}selected{% endif %}>Any</option>
                                <option value="Low (<20%)" {% if filter_params.inst_ownership == 'Low (<20%)' %}selected{% endif %}>Low (&lt;20%)</option>
                                <option value="High (>80%)" {% if filter_params.inst_ownership == 'High (>80%)' %}selected{% endif %}>High (&gt;80%)</option>
                                <option value="Over 10%" {% if filter_params.inst_ownership == 'Over 10%' %}selected{% endif %}>Over 10%</option>
                                <option value="Over 30%" {% if filter_params.inst_ownership == 'Over 30%' %}selected{% endif %}>Over 30%</option>
                                <option value="Over 50%" {% if filter_params.inst_ownership == 'Over 50%' %}selected{% endif %}>Over 50%</option>
                                <option value="Over 70%" {% if filter_params.inst_ownership == 'Over 70%' %}selected{% endif %}>Over 70%</option>
                                <option value="Over 90%" {% if filter_params.inst_ownership == 'Over 90%' %}selected{% endif %}>Over 90%</option>
                                <option value="Under 10%" {% if filter_params.inst_ownership == 'Under 10%' %}selected{% endif %}>Under 10%</option>
                                <option value="Under 30%" {% if filter_params.inst_ownership == 'Under 30%' %}selected{% endif %}>Under 30%</option>
                                <option value="Under 50%" {% if filter_params.inst_ownership == 'Under 50%' %}selected{% endif %}>Under 50%</option>
                                <option value="Under 70%" {% if filter_params.inst_ownership == 'Under 70%' %}selected{% endif %}>Under 70%</option>
                                <option value="Under 90%" {% if filter_params.inst_ownership == 'Under 90%' %}selected{% endif %}>Under 90%</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-cell locked">
                        <div class="filter-label">Insider Ownership</div>
                        <div class="filter-value">
                            <select name="insider_ownership" class="filter-select">
                                <option value="any" {% if filter_params.insider_ownership == 'any' %}selected{% endif %}>Any</option>
                                <option value="Low (<5%)" {% if filter_params.insider_ownership == 'Low (<5%)' %}selected{% endif %}>Low (&lt;5%)</option>
                                <option value="High (>30%)" {% if filter_params.insider_ownership == 'High (>30%)' %}selected{% endif %}>High (&gt;30%)</option>
                                <option value="Over 10%" {% if filter_params.insider_ownership == 'Over 10%' %}selected{% endif %}>Over 10%</option>
                                <option value="Over 20%" {% if filter_params.insider_ownership == 'Over 20%' %}selected{% endif %}>Over 20%</option>
                                <option value="Over 30%" {% if filter_params.insider_ownership == 'Over 30%' %}selected{% endif %}>Over 30%</option>
                                <option value="Over 40%" {% if filter_params.insider_ownership == 'Over 40%' %}selected{% endif %}>Over 40%</option>
                                <option value="Over 50%" {% if filter_params.insider_ownership == 'Over 50%' %}selected{% endif %}>Over 50%</option>
                                <option value="Under 10%" {% if filter_params.insider_ownership == 'Under 10%' %}selected{% endif %}>Under 10%</option>
                                <option value="Under 20%" {% if filter_params.insider_ownership == 'Under 20%' %}selected{% endif %}>Under 20%</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics bar -->
    <div class="statistics-bar">
        <div class="filter-summary">
            <span class="stats-label"><i class="fas fa-filter me-1"></i> Filters:</span>
            <span class="stats-value">{{ filter_count|default:'0' }} active</span>
            {% if filter_count > 0 %}
            <button id="reset-all-filters" class="btn-reset">Reset All</button>
            {% endif %}
        </div>
        <div class="market-stats">
            <div>
                <span class="stats-label">KSE-100:</span>
                <span class="stats-value {% if kse100_change > 0 %}positive{% elif kse100_change < 0 %}negative{% endif %}">
                    {{ kse100_index|default:'N/A' }}
                    {% if kse100_change != 0 %}
                        {% if kse100_change > 0 %}+{% endif %}{{ kse100_change }}%
                    {% endif %}
                </span>
            </div>
            <div>
                <span class="stats-label">Data:</span>
                <span class="stats-value">{{ data_source|default:'Live' }}</span>
            </div>
            <div>
                <span class="stats-label">Volume:</span>
                <span class="stats-value">{{ market_volume|default:'N/A' }}</span>
            </div>
            <div>
                <span class="stats-label">Last Update:</span>
                <span class="stats-value">{{ last_update|default:'N/A' }}</span>
            </div>
        </div>
    </div>

    <!-- Results section with table/charts toggle -->
    <div class="stock-results">
        <!-- Table View Section -->
        <div id="table-view" class="table-section">
            <table class="stock-table">
                <thead>
                    <tr>
                        <th class="sorting-enabled">No.</th>
                        <th class="sorting-enabled">Ticker</th>
                        <th class="sorting-enabled">Company</th>
                        <th class="sorting-enabled">Sector</th>
                        <th class="sorting-enabled">Industry</th>
                        <th class="sorting-enabled">Country</th>
                        <th class="sorting-enabled text-right">Market Cap</th>
                        <th class="sorting-enabled text-right">P/E</th>
                        <th class="sorting-enabled text-right">Price</th>
                        <th class="sorting-enabled text-right">Change %</th>
                        <th class="sorting-enabled text-right">Volume</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks %}
                    <tr>
                        <td>{{ forloop.counter0|add:stocks.start_index }}</td>
                        <td><a href="{% url 'psxscreener:stock_detail' stock.Symbol %}">{{ stock.Symbol }}</a></td>
                        <td>{{ stock.CompanyName }}</td>
                        <td>{{ stock.Sector }}</td>
                        <td>{{ stock.Industry }}</td>
                        <td>{{ stock.Country }}</td>
                        <td class="text-right">{{ stock.MarketCap|intcomma }}</td>
                        <td class="text-right">{{ stock.PERatio|default:"-" }}</td>
                        <td class="text-right">{{ stock.CurrentPrice }}</td>
                        <td class="text-right {% if stock.ChangePercentage > 0 %}positive{% elif stock.ChangePercentage < 0 %}negative{% endif %}">
                            {% if stock.ChangePercentage > 0 %}+{% endif %}{{ stock.ChangePercentage|floatformat:2 }}%
                        </td>
                        <td class="text-right">{{ stock.Volume|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center">No stocks match your criteria</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Chart View Section -->
        <div id="chart-view" class="chart-view">
            <div class="chart-type-toggle">
                <button id="treemap-btn" class="active" onclick="setActiveChartType('treemap')"><i class="fas fa-th-large"></i> Tree Map</button>
                <button id="bubble-btn" onclick="setActiveChartType('bubble')"><i class="fas fa-circle"></i> Bubble Chart</button>
                <button id="line-btn" onclick="setActiveChartType('line')"><i class="fas fa-chart-line"></i> Line Chart</button>
            </div>
            
            <div id="treemap-chart" class="chart-container active"></div>
            <div id="bubble-chart" class="chart-container"></div>
            <div id="line-chart" class="chart-container"></div>
            
            <div class="chart-description mt-3">
                <h5>Chart Information</h5>
                <div id="treemap-info" class="chart-info active">
                    <p>The Tree Map displays market capitalization by sector, with box size representing market cap and color intensity showing performance.</p>
                </div>
                <div id="bubble-info" class="chart-info">
                    <p>The Bubble Chart plots stocks with X-axis showing P/E ratio, Y-axis showing price change, and bubble size representing trading volume.</p>
                </div>
                <div id="line-info" class="chart-info">
                    <p>The Line Chart shows price trends across all selected stocks, providing a visual comparison of performance over time.</p>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        {% if stocks.paginator.num_pages > 1 %}
        <div class="pagination-container">
            <ul class="pagination">
                {% if stocks.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{% for key, value in filter_params.items %}{{ key }}={{ value }}&{% endfor %}{% endif %}page=1" aria-label="First">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{% for key, value in filter_params.items %}{{ key }}={{ value }}&{% endfor %}{% endif %}page={{ stocks.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true">&lt;</span>
                    </a>
                </li>
                {% endif %}

                {% for page_num in stocks.paginator.page_range %}
                    {% if page_num == stocks.number %}
                    <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                    {% elif page_num > stocks.number|add:"-3" and page_num < stocks.number|add:"3" %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if filter_params %}{% for key, value in filter_params.items %}{{ key }}={{ value }}&{% endfor %}{% endif %}page={{ page_num }}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if stocks.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{% for key, value in filter_params.items %}{{ key }}={{ value }}&{% endfor %}{% endif %}page={{ stocks.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true">&gt;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?{% if filter_params %}{% for key, value in filter_params.items %}{{ key }}={{ value }}&{% endfor %}{% endif %}page={{ stocks.paginator.num_pages }}" aria-label="Last">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Premium feature alert -->
    <div class="premium-feature-alert">
        <h3>Premium Feature</h3>
        <p>This feature is only available for premium users. Upgrade now to unlock all features!</p>
        <button class="btn-primary">Upgrade</button>
        <button class="btn-secondary" onclick="closePremiumAlert()">Not Now</button>
    </div>

    <!-- Loading Spinner Overlay -->
    <div class="spinner-overlay" id="loading-overlay">
        <div class="spinner"></div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
    <!-- Load ApexCharts before charts.js -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.js"></script>
    <!-- Make sure ApexCharts is loaded before accessing it -->
    <script>
        // Check if ApexCharts is loaded properly
        window.addEventListener('load', function() {
            if (typeof ApexCharts === 'undefined') {
                console.error('ApexCharts failed to load. Loading it again...');
                var script = document.createElement('script');
                script.src = "https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.min.js";
                script.onload = function() {
                    console.log('ApexCharts loaded successfully');
                    // If we're already on the chart view, initialize charts
                    if (document.getElementById('chart-view').style.display === 'block' && 
                        typeof window.initializeCharts === 'function') {
                        window.initializeCharts();
                    }
                };
                document.head.appendChild(script);
            }
        });
    </script>
    <script src="{% static 'psxscreener/js/charts.js' %}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const body = document.body;
        const themeToggleButton = document.getElementById('theme-toggle');
        const themeIcon = themeToggleButton.querySelector('i');
        const loadingOverlay = document.getElementById('loading-overlay');
        const filterTabsContainer = document.getElementById('filter-tabs-container');
        const showFiltersButton = document.getElementById('show-filters');
        const filterIconToggle = showFiltersButton.querySelector('.filter-icon');
        const premiumFeatureAlert = document.querySelector('.premium-feature-alert');

        // Global function for view toggling
        window.toggleView = function(viewType) {
            console.log('toggleView called with:', viewType);
            const tableViewBtn = document.getElementById('table-view-btn');
            const chartViewBtn = document.getElementById('chart-view-btn');
            const tableView = document.getElementById('table-view');
            const chartView = document.getElementById('chart-view');
            
            if (!tableViewBtn || !chartViewBtn || !tableView || !chartView) {
                console.error('Missing view elements');
                return;
            }
            
            if (viewType === 'table') {
                tableViewBtn.classList.add('active');
                chartViewBtn.classList.remove('active');
                tableView.style.display = 'block';
                chartView.style.display = 'none';
                console.log('Switched to table view');
            } else if (viewType === 'chart') {
                chartViewBtn.classList.add('active');
                tableViewBtn.classList.remove('active');
                tableView.style.display = 'none';
                chartView.style.display = 'block';
                console.log('Switched to chart view');
                
                // Initialize charts if needed
                if (typeof initializeCharts === 'function' && !window.chartsInitialized) {
                    console.log('Initializing charts');
                    initializeCharts();
                }
            }
        };

        // Handle clicks on locked tabs
        const lockedTabs = document.querySelectorAll('.filter-tab.locked');
        lockedTabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                // Show premium feature alert
                if (premiumFeatureAlert) {
                    premiumFeatureAlert.style.display = 'block';
                }
                return false;
            });
        });

        // --- Theme Management ---
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                body.classList.add('dark-theme');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.remove('dark-theme');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                localStorage.setItem('theme', 'light');
            }
            // Update select arrows if needed (more robust methods exist)
             updateSelectArrows();
             
             // Update chart themes if charts are initialized
             if (typeof updateChartTheme === 'function') {
                 setTimeout(updateChartTheme, 100);
             }
        };

        const updateSelectArrows = () => {
             // This is a basic example; might need refinement
             // It re-reads the CSS variable and updates the background-image style property
             // This can be inefficient if called frequently or with many selects
             const selects = document.querySelectorAll('select.control-select, select.filter-select');
             selects.forEach(select => {
                const arrowColor = getComputedStyle(document.documentElement).getPropertyValue('--select-arrow-color').trim().replace('#', '%23');
                select.style.backgroundImage = `url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='${arrowColor}' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e")`;
             });
        }

        themeToggleButton.addEventListener('click', () => {
            const currentTheme = body.classList.contains('dark-theme') ? 'dark' : 'light';
            applyTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        // Check initial theme
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (prefersDark) {
            applyTheme('dark');
        } else {
            applyTheme('light'); // Default to light
        }

        // Listen for OS theme changes (optional)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
             if (!localStorage.getItem('theme')) { // Only change if no user preference is set
                 applyTheme(event.matches ? 'dark' : 'light');
             }
        });
        // --- End Theme Management ---


        // --- Filter Panel Toggle ---
         showFiltersButton.addEventListener('click', () => {
             const isVisible = filterTabsContainer.style.display === 'block';
             filterTabsContainer.style.display = isVisible ? 'none' : 'block';
             filterIconToggle.classList.toggle('fa-chevron-down', isVisible);
             filterIconToggle.classList.toggle('fa-chevron-up', !isVisible);
         });
         // Keep track if filters were open
         const filtersOpen = new URLSearchParams(window.location.search).has('filters_open');
         if(filtersOpen){
              filterTabsContainer.style.display = 'block';
              filterIconToggle.classList.remove('fa-chevron-down');
              filterIconToggle.classList.add('fa-chevron-up');
         }


        // --- Filter Tab Switching ---
        const filterTabs = document.querySelectorAll('.filter-tabs .filter-tab');
        const filterContents = document.querySelectorAll('.filter-section .filter-content');

        filterTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabType = this.getAttribute('data-tab');

                // Deactivate all tabs and content
                filterTabs.forEach(t => t.classList.remove('active'));
                filterContents.forEach(c => {
                    c.classList.remove('active');
                    c.style.display = 'none';
                 });

                // Activate clicked tab and corresponding content
                this.classList.add('active');
                const activeContent = document.getElementById(tabType + '-filters');
                if (activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';
                }
            });
        });

        // Close premium feature alert
        window.closePremiumAlert = function() {
            if (premiumFeatureAlert) {
                premiumFeatureAlert.style.display = 'none';
            }
        };

        // Set up chart type toggle buttons
        const treemapBtn = document.getElementById('treemap-btn');
        const bubbleBtn = document.getElementById('bubble-btn');
        const lineBtn = document.getElementById('line-btn');
        
        if (treemapBtn && typeof setActiveChartType === 'function') {
            treemapBtn.addEventListener('click', function() {
                setActiveChartType('treemap');
            });
        }
        
        if (bubbleBtn && typeof setActiveChartType === 'function') {
            bubbleBtn.addEventListener('click', function() {
                setActiveChartType('bubble');
            });
        }
        
        if (lineBtn && typeof setActiveChartType === 'function') {
            lineBtn.addEventListener('click', function() {
                setActiveChartType('line');
            });
        }
        
        // Set up view toggle buttons
        const tableViewBtn = document.getElementById('table-view-btn');
        const chartViewBtn = document.getElementById('chart-view-btn');
        
        if (tableViewBtn) {
            tableViewBtn.addEventListener('click', function() {
                toggleView('table');
            });
        }
        
        if (chartViewBtn) {
            chartViewBtn.addEventListener('click', function() {
                toggleView('chart');
            });
        }

        // --- Form Creation and Submission Logic ---
        const createFilterForm = function() {
            let filterForm = document.getElementById('filter-form');
            if (!filterForm) {
                filterForm = document.createElement('form');
                filterForm.id = 'filter-form';
                filterForm.method = 'get';
                filterForm.action = window.location.pathname; // Use current path
                filterForm.style.display = 'none'; // Hide the form
                document.body.appendChild(filterForm);
            }
             // Clear previous hidden inputs inside the form before adding new ones
             filterForm.innerHTML = '';
            return filterForm;
        };

        const collectFormData = (form) => {
             // Add sorting parameters from dropdowns
             const sortBy = document.getElementById('order-by')?.value;
             const sortOrder = document.getElementById('order-direction')?.value;
             if (sortBy) addHiddenInput(form, 'sort_by', sortBy);
             if (sortOrder) addHiddenInput(form, 'sort_order', sortOrder);

             // Add search ticker
             const tickerValue = document.getElementById('tickers')?.value;
             if (tickerValue) addHiddenInput(form, 'symbol', tickerValue);

             // Add signal
             const signalValue = document.getElementById('signal')?.value;
             if (signalValue && signalValue !== 'none') addHiddenInput(form, 'signal', signalValue);

             // Add all *active* filter selects (value not 'Any')
             const filterSelects = document.querySelectorAll('.filter-value select');
             filterSelects.forEach(select => {
                 if (select.value && select.value.toLowerCase() !== 'any') {
                     addHiddenInput(form, select.name, select.value);
                 }
             });

             // Preserve pagination (reset to 1 on filter change, keep on sort/search)
             const urlParams = new URLSearchParams(window.location.search);
             const currentPage = urlParams.get('page');
             // Determine if this is a filter change vs sort/search/paginate
             // This check is basic, might need refinement based on trigger event
             const isFiltering = event?.target?.classList.contains('filter-select');
             if (currentPage && !isFiltering) {
                 addHiddenInput(form, 'page', currentPage);
             }

             // Preserve other essential params if needed (e.g., date range)
             // const startDate = urlParams.get('start_date');
             // if (startDate) addHiddenInput(form, 'start_date', startDate);

             // Add flag if filters are open
             if (filterTabsContainer.style.display === 'block') {
                 addHiddenInput(form, 'filters_open', 'true');
             }

        };

        const addHiddenInput = (form, name, value) => {
            let input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        };

        const submitFilterForm = () => {
             if (loadingOverlay) loadingOverlay.classList.add('active'); // Show spinner
             const form = createFilterForm();
             collectFormData(form);
             form.submit();
        };


        // --- Event Listeners for Controls ---

        // Sorting dropdowns
        document.getElementById('order-by')?.addEventListener('change', submitFilterForm);
        document.getElementById('order-direction')?.addEventListener('change', submitFilterForm);

        // Signal dropdown
        document.getElementById('signal')?.addEventListener('change', submitFilterForm);

        // Ticker search button and Enter key
        document.getElementById('search-btn')?.addEventListener('click', submitFilterForm);
        document.getElementById('tickers')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission if inside one
                submitFilterForm();
            }
        });

        // Filter selects
        document.querySelectorAll('.filter-value select').forEach(select => {
            select.addEventListener('change', submitFilterForm);
        });

        // Reset buttons
        document.querySelectorAll('.btn-reset').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                 if (loadingOverlay) loadingOverlay.classList.add('active'); // Show spinner

                const targetTab = this.getAttribute('data-target-tab');
                const filterContent = document.getElementById(`${targetTab}-filters`);

                if (filterContent) {
                    filterContent.querySelectorAll('select').forEach(select => {
                        select.value = 'Any'; // Reset selects in the specific tab
                    });
                }

                // Re-submit form with other filters/sort intact, but this tab's filters cleared
                const form = createFilterForm();
                collectFormData(form); // Collects again, now with 'Any' for reset tab
                form.submit();
            });
        });

        // Update filter counts on load (simple version)
        const updateFilterCounts = () => {
             let totalActive = 0;
             document.querySelectorAll('.filter-content').forEach(content => {
                 const tabId = content.id.replace('-filters', '');
                 const countSpan = document.getElementById(`${tabId}-filter-count`);
                 const resetButton = content.querySelector('.btn-reset');
                 let tabCount = 0;
                 content.querySelectorAll('select').forEach(select => {
                     if (select.value && select.value.toLowerCase() !== 'any') {
                         tabCount++;
                     }
                 });
                 if (countSpan) countSpan.textContent = tabCount;
                 if (resetButton) resetButton.textContent = `Reset ${tabId.charAt(0).toUpperCase() + tabId.slice(1)} (${tabCount})`;
                 totalActive += tabCount;
             });
             document.getElementById('filter-count').textContent = totalActive;
        };
        updateFilterCounts(); // Run on load


        // --- Pagination Functionality ---
        window.navigateToPage = function(page) { // Make it global for inline onclick
             if (loadingOverlay) loadingOverlay.classList.add('active'); // Show spinner
             const form = createFilterForm();
             collectFormData(form); // Collect current filters/sort

             // Ensure page input exists and set value
             let pageInput = form.querySelector('input[name="page"]');
             if (!pageInput) {
                 pageInput = document.createElement('input');
                 pageInput.type = 'hidden';
                 pageInput.name = 'page';
                 form.appendChild(pageInput);
             }
             pageInput.value = page;

             form.submit();
        };

         // Hide spinner on page load if navigation completes
         window.addEventListener('pageshow', function(event) {
            // Check if the page was loaded from the bfcache (back/forward cache)
            if (event.persisted && loadingOverlay) {
                loadingOverlay.classList.remove('active');
            }
            // For regular loads, browser usually handles showing content automatically.
            // If issues persist, might need to remove spinner explicitly after a short delay.
            // setTimeout(() => { if(loadingOverlay) loadingOverlay.classList.remove('active'); }, 50);
         });
         // Also hide spinner if form submission fails or takes too long (less ideal)
         // setTimeout(() => { if(loadingOverlay) loadingOverlay.classList.remove('active'); }, 10000); // Failsafe after 10s

        // --- Filter Availability Management ---
        // Define available and locked filters (based on backend implementation)
        const availableFilters = [
            'symbol', 'exchange', 'sector', 'industry', 'country', 'market_cap', 
            'div_yield', 'div_frequency', 'perf_day', 'perf_week', 'perf_month',
            'inst_ownership', 'insider_ownership', 'avg_volume', 'price', 'pe_ratio', 
            'current_volume', 'rel_volume', 'float', 'shares_outstanding', 'index'
        ];
        
        // Lock/unlock filters based on availability
        function setupFilterAvailability() {
            document.querySelectorAll('.filter-cell').forEach(cell => {
                const selectEl = cell.querySelector('select');
                if (!selectEl) return;
                
                const filterName = selectEl.getAttribute('name');
                if (!availableFilters.includes(filterName)) {
                    // Lock this filter
                    cell.classList.add('locked');
                    selectEl.setAttribute('disabled', 'disabled');
                    selectEl.value = 'Any'; // Reset to default
                    
                    // Add direct visual styling for locked filter cells
                    const isDarkMode = document.body.classList.contains('dark-theme');
                    
                    if (isDarkMode) {
                        cell.style.backgroundColor = 'rgba(0, 0, 0, 0.15)';
                        cell.style.borderLeft = '3px solid #444';
                        selectEl.style.backgroundColor = '#333';
                        selectEl.style.opacity = '0.5';
                    } else {
                        cell.style.backgroundColor = 'rgba(0, 0, 0, 0.03)';
                        cell.style.borderLeft = '3px solid #ccc';
                        selectEl.style.backgroundColor = '#eee';
                        selectEl.style.opacity = '0.7';
                    }
                    
                    selectEl.style.cursor = 'not-allowed';
                    
                    // Add tooltip for better UX
                    const labelEl = cell.querySelector('.filter-label');
                    if (labelEl) {
                        labelEl.setAttribute('title', 'This filter is currently unavailable');
                        // Use both methods to ensure the lock icon appears
                        labelEl.innerHTML = labelEl.textContent + ' <i class="fas fa-lock"></i>'; // Font Awesome icon
                        
                        // Add a text-based fallback in case FontAwesome is slow to load
                        if (!cell.querySelector('.lock-text')) {
                            const lockText = document.createElement('span');
                            lockText.className = 'lock-text';
                            lockText.textContent = '🔒'; // Unicode lock symbol as fallback
                            lockText.style.fontSize = '0.8rem';
                            lockText.style.marginLeft = '4px';
                            lockText.style.display = 'none'; // Hide initially
                            
                            // If FontAwesome is not loaded after 1s, show Unicode fallback
                            setTimeout(() => {
                                if (!document.querySelector('.fa')) {
                                    lockText.style.display = 'inline';
                                }
                            }, 1000);
                            
                            labelEl.appendChild(lockText);
                        }
                    }
                } else {
                    // Ensure it's unlocked
                    cell.classList.remove('locked');
                    selectEl.removeAttribute('disabled');
                }
            });
            
            // Check each filter tab section for all-locked filters
            document.querySelectorAll('.filter-content').forEach(section => {
                const filterCells = section.querySelectorAll('.filter-cell');
                const lockedCells = section.querySelectorAll('.filter-cell.locked');
                
                // If all filters in this section are locked, show a notification
                if (filterCells.length > 0 && filterCells.length === lockedCells.length) {
                    const tabId = section.id;
                    const countHeader = section.querySelector('.filter-count-header');
                    
                    // Only add notification if we haven't already
                    if (countHeader && !section.querySelector('.all-locked-notification')) {
                        const notification = document.createElement('div');
                        notification.className = 'all-locked-notification';
                        notification.innerHTML = '<i class="fas fa-lock"></i> All filters in this section are currently unavailable';
                        notification.style.color = 'var(--dark-gray)';
                        notification.style.fontStyle = 'italic';
                        notification.style.marginTop = '0.5rem';
                        notification.style.display = 'flex';
                        notification.style.alignItems = 'center';
                        notification.style.gap = '0.5rem';
                        notification.style.justifyContent = 'center';
                        countHeader.appendChild(notification);
                    }
                }
            });
            
            // Update filter counts after locking/unlocking
            updateFilterCounts();
        }
        
        // Run filter availability setup on page load
        setupFilterAvailability();
    });
    </script>
{% endblock scripts %}

{% block extra_scripts %}
    <!-- ApexCharts library -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Old chart initialization code removed, now handled by charts.js -->
{% endblock extra_scripts %}